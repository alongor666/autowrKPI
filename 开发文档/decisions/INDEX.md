# 🧠 技术决策记录层 (decisions/)

> **职责**: 记录所有重要的技术决策、架构变更、口径调整（ADR - Architecture Decision Records）
> **更新时间**: 2026-01-02
> **维护规则**: 任何涉及架构、口径、阈值的变更必须先创建ADR

---

## 📖 目录职责

本目录采用 **ADR（Architecture Decision Record）** 模式，记录项目中所有重要决策的背景、方案、取舍与后果。是理解"为什么这样做"的唯一权威来源。

---

## 🔑 决策清单（按ID排序）

| 决策ID | 标题 | 日期 | 状态 | 影响范围 | 关联功能 |
|--------|------|------|------|---------|---------|
| **D001** | [ECharts-CDN加载优化](./D001_ECharts-CDN加载优化.md) | 2025-12 | ✅ accepted | CDN加载、性能优化 | F006, F008 |
| **D002** | [JavaScript数据聚合逻辑对等实现](./D002_JavaScript数据聚合逻辑对等实现.md) | 2025-12 | ✅ accepted | 数据聚合、Worker架构 | F004 |
| **D003** | [图表优化与损失暴露分析](./D003_图表优化与损失暴露分析.md) | 2025-12 | ✅ accepted | 图表配色、预警线、双Y轴 | F008, 板块04, 板块05 |

---

## 📂 按状态分类

### ✅ 已接受（Accepted）
- **D001**: ECharts-CDN加载优化
- **D002**: JavaScript数据聚合逻辑对等实现
- **D003**: 图表优化与损失暴露分析

### 🚧 提议中（Proposed）
- 无

### ⚠️ 已废弃（Deprecated）
- 无

### 🔄 已替代（Superseded）
- 无

---

## 📖 ADR 标准结构

每个ADR文档必须包含以下章节：

### 1. 标题与元数据
```markdown
# D001: ECharts-CDN加载优化

- **状态**: accepted / proposed / deprecated / superseded
- **日期**: 2025-12-XX
- **决策者**: @team / @alice
- **影响范围**: 功能模块、代码文件
```

### 2. 背景（Context）
- **问题描述**: 遇到了什么问题？
- **业务需求**: 为什么需要做这个决策？
- **技术现状**: 当前实现是怎样的？

### 3. 决策（Decision）
- **选择的方案**: 最终采用的技术方案
- **关键理由**: 为什么选择这个方案？

### 4. 替代方案（Alternatives Considered）
- **方案A**: 描述 + 优缺点 + 为什么不选
- **方案B**: 描述 + 优缺点 + 为什么不选
- **方案C**: ...

### 5. 后果（Consequences）
- **正面影响**: 带来了哪些好处？
- **负面影响**: 引入了哪些风险或限制？
- **迁移成本**: 需要多少工作量？

### 6. 验证（Verification）
- **验证方法**: 如何验证决策有效？
- **验证结果**: （如已实施）实际效果如何？

### 7. 参考资料（References）
- 相关Issue、PR、外部文档链接

---

## 📊 决策类型分类

### 架构决策类
- **D002**: JavaScript数据聚合逻辑对等实现（Worker架构）

### 性能优化类
- **D001**: ECharts-CDN加载优化（CDN策略）

### UI/UX设计类
- **D003**: 图表优化与损失暴露分析（配色、预警线）

### 业务规则类
- （未来）指标口径调整、阈值变更等

---

## 🔗 决策详解

### D001: ECharts-CDN加载优化

**核心决策**: 使用 BootCDN 替代 jsDelivr，并实施版本锁定策略

**背景**:
- jsDelivr 在国内访问不稳定
- ECharts 版本不一致导致API兼容性问题

**影响范围**:
- `index.html`: CDN链接修改
- `js/dashboard.js`: ECharts API调用

**关联功能**:
- [F006 - 静态部署系统](../01_features/F006_static_deployment/README.md)
- [F008 - 交互式数据可视化仪表盘](../01_features/F008_dashboard_visualization/README.md)

**验证结果**: 页面加载时间从 5s 降至 1.5s（国内环境）

---

### D002: JavaScript数据聚合逻辑对等实现

**核心决策**: 在 Web Worker 中实现数据聚合逻辑，与Python后端逻辑对等

**背景**:
- 原Python后端聚合逻辑需要迁移到纯前端
- 数据量大（16000+行），需避免主线程阻塞

**技术方案**:
- 使用 Web Worker 进行后台数据处理
- 实现 `aggregateByDimension()` 函数，逻辑与Python版本一致
- 采用一次性监听器模式防止内存泄漏

**影响范围**:
- `js/data.worker.js:477-600`: 聚合逻辑实现
- `js/dashboard.js:675-686`: Worker通信管理

**关联功能**:
- [F004 - 数据聚合与统计](../01_features/F004_data_aggregation/README.md)

**验证结果**: 处理16000行数据耗时 < 500ms，UI无卡顿

---

### D003: 图表优化与损失暴露分析

**核心决策**: 统一图表配色规范，引入预警线，实现双Y轴图表

**背景**:
- 原图表配色不符合业务规范（满期赔付率用红色）
- 缺少直观的预警线提示
- 损失暴露分析需要频度×强度双Y轴展示

**关键变更**:
1. **配色调整**:
   - 保费贡献度: `#e0e0e0`（浅灰色）
   - 赔款贡献度: `#a6a6a6`（灰色）
   - 满期赔付率线条: `#0070c0`（蓝色）
2. **预警线**: 满期赔付率统一设置70%预警线
3. **双Y轴**: 左轴-贡献度（柱状图），右轴-满期赔付率（折线图）

**影响范围**:
- `js/dashboard.js:404-616`: 图表配置
- [板块文档/04_变动成本板块.md](../板块文档/04_变动成本板块.md)
- [板块文档/05_损失暴露板块.md](../板块文档/05_损失暴露板块.md)

**关联功能**:
- [F008 - 交互式数据可视化仪表盘](../01_features/F008_dashboard_visualization/README.md)

**验证结果**: 业务方确认配色符合行业规范，预警线提升决策效率

---

## 🔄 创建ADR流程

### 何时需要创建ADR？

1. **架构变更**：引入新技术、改变系统结构
2. **性能优化**：影响用户体验的重大优化
3. **业务规则变更**：指标口径、阈值调整
4. **UI/UX重设计**：影响用户交互的设计变更
5. **配置文件修改**：`/reference/` 下的配置变更

### 创建步骤

1. **确定决策ID**
   - 格式: `DXXX`（X为下一个可用编号）
   - 查看当前最大ID，递增1

2. **创建文件**
   ```bash
   # 文件命名格式
   DXXX_决策标题.md
   ```

3. **填写内容**
   - 按ADR标准结构填写
   - 必须包含：背景、决策、替代方案、后果

4. **关联更新**
   - 在本INDEX.md的"决策清单"表格中新增一行
   - 更新相关功能文档（`/开发文档/01_features/`）
   - 更新相关板块文档（`/开发文档/板块文档/`）
   - 如涉及配置变更，更新 `/reference/INDEX.md`

5. **评审与确认**
   - 团队评审ADR
   - 确认影响范围
   - 更新状态为 `accepted`

6. **实施与验证**
   - 按ADR执行变更
   - 记录验证结果
   - 更新ADR的"验证"章节

---

## 📌 维护注意事项

- **ID连续性**：决策ID必须连续递增，不得跳号
- **禁止删除**：已接受的ADR不得删除，只能标记为 `deprecated` 或 `superseded`
- **状态管理**：
  - `proposed`: 提议中，待评审
  - `accepted`: 已接受，已实施
  - `deprecated`: 已废弃，不再使用
  - `superseded`: 已被新决策替代（需注明被哪个ADR替代）
- **强制关联**：每个ADR必须关联至少一个功能文档或板块文档

---

## 🔍 查询指南

### 如何查找某个功能的决策背景？
1. 在 [01_features/INDEX.md](../01_features/INDEX.md) 查找功能对应的"关联决策"
2. 点击决策链接查看详细ADR

### 如何查找某个配置变更的原因？
1. 在 [reference/INDEX.md](../../reference/INDEX.md) 查看配置文件的"变更规则"
2. 搜索相关ADR标题

### 如何了解架构演进历史？
1. 查看本INDEX.md的"决策清单"，按时间排序
2. 阅读相关ADR的"背景"和"后果"章节

---

**全局文档索引**: [DOC_INDEX.md](../00_index/DOC_INDEX.md)
**配置变更指南**: [reference/INDEX.md](../../reference/INDEX.md)
**最后更新**: 2026-01-02
**维护者**: autowrKPI Governance Team
