# F007 - 智能元数据提取与分析模式识别

## 功能概述

从上传的CSV数据中自动提取关键元数据（保单年度、周次、更新日期、机构信息），支持中英文字段名自动识别，并根据三级机构数量智能判断分析模式（单机构分析/多机构对比）。

## 业务背景

### 问题场景
- CSV数据源可能使用中文字段名（如"保单年度"）或英文字段名（如"policy_start_year"）
- 不同数据导出可能包含单个机构数据或多个机构数据
- 用户需要在上传文件后立即了解数据的基本信息
- 报告标题和模式需要根据实际数据动态调整

### 解决方案
通过字段名映射表和智能匹配算法，自动识别CSV中的关键字段，并提取元数据信息。同时统计三级机构数量，判断是单机构分析还是多机构对比场景。

## 核心逻辑

### 1. 字段映射机制

**字段映射表**（js/data.worker.js:383-412）：
```javascript
const fieldMapping = {
    year: ['保单年度', 'policy_start_year', '年度', '年份'],
    week: ['周次', 'week_number', '周'],
    date: ['snapshot_date', '快照日期', '更新日期', '统计日期'],
    organization: ['机构', '三级机构', 'third_level_organization', '分公司', '机构名称'],
    secondOrg: ['二级机构', 'second_level_organization']
};
```

**智能查找逻辑**：
- 遍历每个字段的候选名称列表
- 检查CSV第一行是否存在该字段
- 返回第一个匹配的值

### 2. 分析模式识别

**识别算法**（js/data.worker.js:430-442）：
1. 提取CSV中所有三级机构名称，去重后统计数量
2. 如果 `organizationCount === 1`：单机构分析模式
3. 如果 `organizationCount > 1`：多机构对比模式

**标题生成规则**：
- 单机构：`{机构名}车险第{周次}周经营分析`
- 多机构：`{二级机构}车险第{周次}周经营分析（多机构对比）`

### 3. 元数据预览

**UI组件**（index.html:113-139, dashboard.js:454-530）：
- 文件上传后即时显示元数据卡片
- 包含：保单年度、周次、更新日期、分析模式、机构信息
- 使用彩色徽章区分单机构（绿色）和多机构（蓝色）

## 技术选型

| 技术 | 选型 | 理由 |
|------|------|------|
| **数据提取** | 原生JavaScript | 轻量级，无需额外依赖 |
| **字段匹配** | 数组遍历查找 | 简单高效，支持多字段名 |
| **去重统计** | Set数据结构 | 自动去重，O(1)查找性能 |
| **UI渲染** | 模板字符串 | 动态生成HTML，易维护 |

## 使用示例

### 场景1：中文字段CSV（单机构）
```csv
保单年度,周次,机构,业务类型,保费收入
2025,50,天府,营业货车,1500000
2025,50,天府,非营业客车,800000
```

**提取结果**：
```javascript
{
  year: "2025",
  week: "50",
  updateDate: null,
  company: "天府",
  analysisMode: "single",
  organizationCount: 1,
  organizations: ["天府"],
  title: "天府车险第50周经营分析"
}
```

### 场景2：英文字段CSV（多机构）
```csv
snapshot_date,policy_start_year,week_number,third_level_organization
2025-12-14,2025,50,乐山
2025-12-14,2025,50,天府
2025-12-14,2025,50,宜宾
```

**提取结果**：
```javascript
{
  year: "2025",
  week: "50",
  updateDate: "2025-12-14",
  company: "四川分公司",
  analysisMode: "multi",
  organizationCount: 13,
  organizations: ["乐山", "天府", "宜宾", ...],
  title: "四川分公司车险第50周经营分析（多机构对比）"
}
```

## 调试信息

控制台输出详细的提取过程：
```javascript
CSV数据已缓存，行数: 1523
📊 提取的元数据: {...}
分析模式: 多机构对比
机构数量: 13
机构列表: ["乐山", "天府", "宜宾", ...]
```

## 已知问题

### 1. 字段名冲突处理
- **问题**：如果CSV同时包含"机构"和"三级机构"字段，只会匹配第一个
- **影响**：可能提取到错误的机构字段
- **缓解**：字段映射顺序按照优先级排列

### 2. 日期格式兼容性
- **问题**：只支持 ISO 8601 格式（YYYY-MM-DD）
- **影响**：其他日期格式需手动处理
- **待优化**：添加日期格式自动识别

### 3. 机构层级判断
- **问题**：多机构时默认使用"二级机构"字段，如果不存在则使用固定值"四川分公司"
- **影响**：可能不适用于其他分公司数据
- **待优化**：添加配置化的默认机构名称

## 相关文件

- 核心实现：`js/data.worker.js:375-475` (extractDynamicInfo函数)
- UI组件：`index.html:113-139` (元数据卡片HTML)
- 渲染逻辑：`js/dashboard.js:454-530` (renderMetadata方法)
- 样式文件：`css/dashboard.css:801-882` (元数据卡片样式)
- 测试数据：`开发文档/test_2025保单第49周变动成本明细表_天府.csv` (单机构)
- 测试数据：`开发文档/test_2025保单第50周变动成本率明细表_四川分公司.csv` (多机构)

## 更新日志

### 2025-12-17
- ✅ **完整实现所有功能**
- ✅ 添加更新日期字段提取（snapshot_date等）
- ✅ 添加二级机构字段提取（second_level_organization等）
- ✅ 实现元数据预览UI卡片（6项信息展示）
- ✅ 添加控制台调试日志（年度、周次、机构列表等）
- ✅ 添加字段格式验证（日期格式检查）
- ✅ 完善字段映射表（新增"年份"、"周"等候选字段）
- ✅ 实现renderMetadata渲染方法
- ✅ 添加响应式CSS样式
- ✅ 更新文档路径引用

### 2025-12-15
- 实现智能字段映射功能（初版）
- 添加分析模式自动识别
- 创建元数据预览UI组件（文档设计）
