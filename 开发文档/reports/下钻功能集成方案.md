# 报告内嵌式下钻筛选功能集成方案

> **创建时间**: 2025-12-16
> **目标**: 在现有的动态生成报告中集成“下钻筛选”（全局维度值筛选），保持麦肯锡风格设计
> **状态**: 待实施

---

## 1. 需求澄清（请以此为准）

### 1.1 ❌ 错误设计（需要废弃）
- 将“下钻”理解为：在图表或KPI上点击 → 进入/触发下钻。
- 该设计会导致每张图表都有自己的入口与状态，且很难保证全页一致的筛选语义。

### 1.2 ✅ 正确设计（用户真实需求）
“下钻”本质上是**像筛选器一样**工作：
1. 用户在顶部控制区选择：**哪些维度**、每个维度**选哪些值**（可多选）。
2. 点击【确定/应用】后，下钻条件成为**全局筛选条件**。
3. **所有图表与KPI统一使用筛选后的数据**刷新，保持口径一致。
4. 时间筛选（年度/周序号）与下钻筛选是**叠加关系**：`时间筛选` → `下钻筛选` → `汇总/渲染`。


## 2. 技术架构（以“单一数据源 + 全页刷新”为核心）

### 2.1 当前报告生成流程（不变）
```
用户上传CSV
  ↓
StaticReportGenerator.parseCSV()
  ↓
processData() → transformToTemplateData()
  ↓
generateHTML() → 注入 DATA 对象到HTML模板
  ↓
在 iframe 中渲染报告
```

### 2.2 筛选与渲染的数据流（新增下钻筛选层）
```
rawCSVData（原始明细，注入到window）
  ↓ 时间筛选（年度/周序号）
timeFilteredData
  ↓ 下钻筛选（维度/值集合）
drillFilteredData
  ↓ 报告所需聚合（按模板既有口径）
templateData（用于全页图表/KPI）
  ↓
renderAll(templateData)
```

### 2.3 核心文件与可复用能力

1. `static/js/static-report-generator.js`（可复用）
   - `formatAmount()`：金额格式化
   - `extractTimeFilterOptions()`：提取年度/周次选项
   - `applyTimeFilter()`：时间筛选
   - `getDrillDownDimensions()`：下钻维度配置（字段映射）
   - 现有的 `applyDrillPathFilter()/aggregateByDrillPath()`：更偏“路径式单值下钻”，可参考实现，但本方案以“筛选器式（可多选）”为准

2. `static/templates/四川分公司车险第49周经营分析模板.html`（改造）
   - 增加顶部控制区 UI
   - 增加下钻筛选状态与“统一刷新入口”

---

## 3. 实施方案

### 阶段1：数据注入（必需）
目标：保证报告在 iframe 内可拿到明细数据，用于“时间筛选 + 下钻筛选”后全页重算。

#### 3.1 修改 `static-report-generator.js`
在 `generateReport()` 保存原始CSV，在 `generateHTML()` 注入到报告页：
- `window.reportData = DATA;`（已有）
- `window.rawCSVData = <raw rows>;`（新增）

建议实现要点（示例，仅说明注入方式；以仓库现有 `generateHTML()` 拼接逻辑为准）：
```js
// generateReport(): 解析后保存明细
this.rawCSVData = csvData;

// generateHTML(): 注入到报告页（避免 `<` 破坏 script）
const injectedRawData = JSON.stringify(this.rawCSVData || []).replace(/</g, '\\u003c');
const injectedLine = [
  `let DATA = ${injectedDataLiteral};`,
  `window.reportData = DATA;`,
  `window.rawCSVData = ${injectedRawData};`,
  `window.dynamicInfo = ${injectedDynamicInfoLiteral};`
].join('\\n');
```

### 阶段2：模板 UI（控制区）
目标：把“下钻”从“点图表触发”改为“像筛选器一样选择后应用”。

建议在 `<body>` 顶部插入固定控制区，包含两块：
1. 时间筛选（年度/周范围 + 应用）
2. 下钻筛选（维度选择 + 值选择 + 应用/重置 + 条件展示）

下钻筛选最小可用 UI（MVP）建议：
- “添加维度”下拉框（来自 `getDrillDownDimensions()`）
- 已选维度列表：每个维度一个按钮【选择值】+ 已选数量展示
- 值选择弹窗：checkbox 列表 + 搜索 + 全选/清空 + 取消/确定
- 底部按钮：【应用下钻】、【重置下钻】

### 阶段3：状态管理与筛选应用（核心）
目标：实现“draft/applied”的筛选语义，避免“每次点选立即影响全页”带来的跳变。

建议状态结构：
```js
const filterState = {
  rawData: [],
  time: { applied: { year: null, weekRange: [1, 52], fieldNames: null } },
  drill: {
    dimensionConfigs: [],
    applied: [], // [{ dimension: 'branch_l3', values: ['天府','渝北'] }]
    draft: []    // 同结构，用于弹窗编辑
  }
};
```

筛选规则建议：
- 维度之间：AND（必须同时满足）
- 同一维度的多个值：OR（命中任一值即可）

核心函数建议（放在模板 `<script>` 中）：
- `applyAllFiltersAndRender()`：唯一刷新入口
  - `timeFiltered = applyTimeFilter(rawData, ...)`
  - `drillFiltered = applyDrillSelections(timeFiltered, drill.applied, configs)`
  - `templateData = recalcTemplateData(drillFiltered)`（复用/迁移模板内既有汇总逻辑）
  - `renderAll(templateData)`（刷新所有图表与KPI）
- `applyDrillSelections(data, selections, configs)`：实现多维多值过滤
- `openValuePicker(dimensionKey)` / `confirmValuePicker()`：维护 `draft`
- `applyDrill()`：`drill.applied = deepClone(drill.draft)`，再调用 `applyAllFiltersAndRender()`
- `resetDrill()`：清空 `draft/applied`，调用 `applyAllFiltersAndRender()`

### 阶段4：刷新入口收口（确保全页一致）
目标：时间筛选与下钻筛选都走同一条“重算→渲染”的路径，避免局部图表各算各的。

建议把模板中“初始化图表/KPI”和“数据刷新”逻辑做一次收口：
- 初始化时：读取 `window.rawCSVData`，初始化筛选器选项与默认值，然后调用一次 `applyAllFiltersAndRender()`
- 任一筛选点击【应用】时：只更新 state，再调用 `applyAllFiltersAndRender()`

---

## 4. 需要修改的文件清单

### 4.1 `static/js/static-report-generator.js`
- [ ] `generateReport()` 保存原始CSV到 `this.rawCSVData`
- [ ] `generateHTML()` 注入 `window.rawCSVData`

### 4.2 `static/templates/四川分公司车险第49周经营分析模板.html`
- [ ] `<body>` 顶部插入控制区（时间筛选 + 下钻筛选）
- [ ] 增加下钻筛选弹窗/样式（尽量不引入新依赖，KISS）
- [ ] 增加 `filterState` 与 `applyAllFiltersAndRender()`（统一刷新入口）
- [ ] 将全页图表与KPI刷新改为读取“筛选后数据”的同一份 `templateData`

### 4.3 （可选）`static/index.html`
- [ ] 增加“下钻筛选说明”提示（告诉用户：先选维度和值，再应用）

---

## 5. 实施步骤（下次对话直接执行）

1. 读取 `static/templates/四川分公司车险第49周经营分析模板.html`，定位：
   - 图表初始化与刷新逻辑位置
   - KPI填充逻辑位置
   - 合适的控制区插入点
2. 修改 `static/js/static-report-generator.js`，完成 `window.rawCSVData` 注入
3. 在模板新增控制区 HTML/CSS（对齐 `开发文档/reports/UI_DESIGN_DRILLDOWN.md`）
4. 在模板新增筛选状态与下钻选择弹窗逻辑（draft/applied）
5. 将“重算与渲染”收口到 `applyAllFiltersAndRender()`，验证时间筛选与下钻筛选叠加效果

---

## 6. UI 设计要求（保持麦肯锡风格）
- 主题色: `#a02724`
- 控制区底边框/主按钮: 使用主题色
- 次按钮/边框: `#f5f5f5` / `#ddd`
- Hover: `#8a1f1c`

---

## 7. 注意事项
1. **原始数据体积**: CSV过大时，注入 `window.rawCSVData` 会导致HTML体积膨胀；必要时考虑只注入“可重算所需的最小明细列”
2. **字段映射**: 下钻维度字段名应严格走 `getDrillDownDimensions().csvFields` 进行兼容
3. **一致性优先**: 所有图表与KPI必须使用同一份筛选后数据源，禁止各自重复过滤实现（DRY）

---

**文档版本**: v2.0
**最后更新**: 2025-12-16
