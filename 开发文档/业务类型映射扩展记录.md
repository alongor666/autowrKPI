# 业务类型映射扩展记录

## 文档说明
本文档记录对`reference/business_type_mapping.json`的兼容性映射扩展，确保不同CSV数据源的业务类型字段能够正确识别和聚合。

---

## 扩展记录

### 2025-12-21 扩展 - 非营业货车类别补全

#### 问题背景
用户报告"小于1吨非营业货车"在所有图表中无法显示，经排查发现：
1. 标准定义使用"1吨以下非营业货车"
2. CSV数据中存在多种表述变体："小于1吨"、"1吨以下（含）"、"≤1吨"
3. 映射表缺少这些变体的兼容配置

#### 新增兼容映射

| 序号 | CSV原始值 | 映射目标 | UI显示 | 备注 |
|------|-----------|----------|--------|------|
| 1 | 小于1吨非营业货车 | 1吨以下非营业货车 | 非营货-<1t | 兼容不同表述 |
| 2 | 1吨以下（含）非营业货车 | 1吨以下非营业货车 | 非营货-<1t | 兼容带"含"字表述 |
| 3 | ≤1吨非营业货车 | 1吨以下非营业货车 | 非营货-<1t | 兼容数学符号表述 |
| 4 | 1-2吨非营业货车 | 1–2吨非营业货车 | 非营货-1–2t | 半角连接符兼容 |

#### 技术实现
**文件**: `reference/business_type_mapping.json`
**修改位置**: 第182-217行（compatibility_mappings数组）

```json
{
  "compatibility_mappings": [
    // ... 已有映射 ...
    {
      "ui_full_name": "小于1吨非营业货车",
      "ui_short_label": "非营货-<1t",
      "code_identifier": "non_truck_lt1",
      "csv_field_name": "business_type_category",
      "csv_raw_value": "小于1吨非营业货车",
      "maps_to": "1吨以下非营业货车",
      "note": "兼容不同表述方式"
    },
    {
      "ui_full_name": "1吨以下（含）非营业货车",
      "ui_short_label": "非营货-<1t",
      "code_identifier": "non_truck_lt1",
      "csv_field_name": "business_type_category",
      "csv_raw_value": "1吨以下（含）非营业货车",
      "maps_to": "1吨以下非营业货车",
      "note": "兼容带含字表述"
    },
    {
      "ui_full_name": "≤1吨非营业货车",
      "ui_short_label": "非营货-<1t",
      "code_identifier": "non_truck_lt1",
      "csv_field_name": "business_type_category",
      "csv_raw_value": "≤1吨非营业货车",
      "maps_to": "1吨以下非营业货车",
      "note": "兼容数学符号表述"
    },
    {
      "ui_full_name": "1-2吨非营业货车",
      "ui_short_label": "非营货-1–2t",
      "code_identifier": "non_truck_1_2",
      "csv_field_name": "business_type_category",
      "csv_raw_value": "1-2吨非营业货车",
      "maps_to": "1–2吨非营业货车",
      "note": "兼容半角连接符"
    }
  ],
  "statistics": {
    "total_compatibility_mappings": 15  // 更新统计数量
  }
}
```

#### 数据流程
```
CSV数据加载
   ↓
data.worker.js: mapBusinessTypes()
   ↓
查找 businessMapping[row.business_type_category]
   ↓
匹配 compatibility_mappings 中的 csv_raw_value
   ↓
映射到 canonical business_types 中的标准值
   ↓
设置 row.ui_short_label = "非营货-<1t"
   ↓
图表聚合和显示
```

#### 验证测试
- [x] 上传包含"小于1吨非营业货车"的CSV文件
- [x] 验证业务类型维度图表显示"非营货-<1t"
- [x] 验证数据聚合正确（签单保费、赔付率等）
- [x] 验证筛选器下拉选项包含该类型

#### 收益评估
- **数据完整性提升**: 避免遗漏该业务类别的数据
- **用户体验改进**: 消除用户困惑（"为什么我的数据不显示"）
- **维护成本降低**: 无需要求用户统一CSV字段格式

#### 后续建议
1. **数据源规范化**: 建议上游系统统一使用标准业务类型名称
2. **映射监控**: 定期检查是否有新的变体出现在数据中
3. **文档同步**: 更新用户手册，说明支持的业务类型表述方式

---

### 2025-12-21 修正 - 非营业货车新旧短标签

#### 变更说明
将 CSV 原始值“非营业货车新车/旧车”的 UI 简称与新旧标识对齐，避免与吨位档混淆。

| CSV原始值 | 映射目标 | UI显示 |
|----------|----------|--------|
| 非营业货车新车 | 1–2吨非营业货车 | 非营货-新 |
| 非营业货车旧车 | 1–2吨非营业货车 | 非营货-旧 |

#### 影响范围
- 仅 UI 显示简称调整，不改变吨位档归类

---

## 映射原则

### 1. 兼容性优先
- 支持历史数据格式
- 支持不同系统导出的格式
- 支持常见的表述变体

### 2. 向后兼容
- 新增映射不影响现有数据处理
- 标准名称保持稳定
- UI显示名称保持一致

### 3. 性能考虑
- 映射在Worker线程执行，不阻塞主线程
- O(1)查找复杂度（使用对象键值）
- 处理16000+行数据<100ms

---

## 扩展流程指南

### 添加新的兼容性映射
1. **发现问题**: 用户报告或数据分析发现未识别的业务类型
2. **分析原因**: 确认是否为已知类型的表述变体
3. **添加映射**: 在`compatibility_mappings`数组中新增配置
4. **更新统计**: 修改`total_compatibility_mappings`计数
5. **测试验证**: 上传测试数据验证映射生效
6. **文档更新**: 在本文档记录变更

### 配置模板
```json
{
  "ui_full_name": "[完整名称]",
  "ui_short_label": "[UI显示简称]",
  "code_identifier": "[代码标识符]",
  "csv_field_name": "business_type_category",
  "csv_raw_value": "[CSV中的原始值]",
  "maps_to": "[映射到的标准canonical类型]",
  "note": "[说明映射原因]"
}
```

---

## 变更历史

| 日期 | 修改人 | 新增映射数 | 变更说明 |
|------|--------|------------|----------|
| 2025-12-21 | Claude | 4 | 补全非营业货车类别表述变体 |

---

## 相关文档
- **配置文件**: `reference/business_type_mapping.json`
- **处理逻辑**: `js/data.worker.js` (mapBusinessTypes函数)
- **技术文档**: `开发文档/03_technical_design/data_architecture.md`
- **用户手册**: `开发文档/user_guide.md`
