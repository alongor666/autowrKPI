

⏺ 📋 完整数据聚合逻辑实现行动方案

  一、问题分析

  1.1 当前状态

  - ✅ 已完成：删除HTML模板硬编码数据（703行）
  - ✅ 已完成：实现基础数据转换（transformToTemplateData）
  - ⚠️ 不完整：当前实现只支持三级机构维度的数据聚合
  - ❌ 缺失：缺少客户类别和业务类型两个维度的数据聚合
  - ❌ 缺失：缺少与年度计划数据的关联计算

  1.2 核心问题

  问题：简化版的transformToTemplateData方法与Python后端逻辑不对等，导致：
  1. dataByCategory 和 dataByBusinessType 使用了相同的机构数据（临时方案）
  2. 年计划达成率固定为100%（未实际计算）
  3. 缺少对reference/year-plans.json的读取和关联

  1.3 影响范围

  - 前端功能：多维度切换（三级机构/客户类别/业务类型）显示不正确
  - 数据准确性：KPI计算不完整
  - 用户体验：无法进行多维度分析对比

  ---
  二、目标定义

  2.1 核心目标

  实现与Python后端完全对等的数据聚合逻辑，支持：
  1. ✅ 三级机构维度聚合（已完成）
  2. 🎯 客户类别维度聚合（待实现）
  3. 🎯 业务类型维度聚合（待实现）
  4. 🎯 年度计划达成率计算（待实现）

  2.2 质量目标

  - 数据一致性：JavaScript生成的DATA对象与Python后端生成的完全一致
  - 代码可维护性：遵循DRY原则，提取通用聚合方法
  - 性能要求：3000+行CSV数据处理时间 < 2秒

  ---
  三、技术方案设计

  3.1 架构设计

  CSV原始数据
      ↓
  1. 数据预处理
     - 字段映射（中英文兼容）
     - 业务类型映射（business_type_mapping.json）
      ↓
  2. 多维度聚合（通用方法）
     - 按三级机构聚合 → dataByOrg
     - 按客户类别聚合 → dataByCategory
     - 按业务类型聚合 → dataByBusinessType
      ↓
  3. KPI计算（每个维度）
     - 满期赔付率、费用率、变动成本率
     - 出险率、案均赔款
     - 保费占比、赔款占比
     - 年计划达成率（关联year-plans.json）
      ↓
  4. 问题机构检测
     - 成本超标、保费未达标、费用率高
      ↓
  5. 组装最终DATA对象

  3.2 核心方法设计

  方法1：_aggregateByDimension(csvData, dimensionField, labelName, planMap)

  职责：通用维度聚合方法（DRY原则）
  - 输入：
    - csvData: 原始CSV数据数组
    - dimensionField: 聚合维度字段名（如'third_level_organization'）
    - labelName: 输出标签名（如'机构'）
    - planMap: 年度计划映射（可选）
  - 输出：聚合后的数据数组
  - 逻辑：
    a. 按dimensionField分组
    b. 每组计算所有KPI
    c. 计算占比
    d. 关联年度计划（如果提供）
    e. 按签单保费降序排序

  方法2：_calculateKPIsForGroup(groupData, plan)

  职责：计算单个分组的所有KPI指标
  - 输入：
    - groupData: 单个分组的数据
    - plan: 年度计划值（可选）
  - 输出：包含所有KPI的对象
  - 计算项：16个核心KPI指标

  方法3：_mapBusinessTypes(csvData)

  职责：应用业务类型映射
  - 输入：原始CSV数据
  - 输出：添加了ui_short_label字段的数据
  - 依赖：reference/business_type_mapping.json

  3.3 数据流设计

  transformToTemplateData(csvData) {
      // 1. 预处理：业务类型映射
      const mappedData = this._mapBusinessTypes(csvData);

      // 2. 计算全局统计（用于占比计算）
      const { totalPremium, totalClaim } = this._calculateGlobalStats(mappedData);

      // 3. 加载年度计划
      const planMap = this._loadYearPlans(); // 从this.yearPlans读取

      // 4. 多维度聚合
      const dataByOrg = this._aggregateByDimension(
          mappedData,
          'third_level_organization',
          '机构',
          planMap,
          totalPremium,
          totalClaim
      );

      const dataByCategory = this._aggregateByDimension(
          mappedData,
          'customer_category_3',
          '客户类别',
          null,  // 客户类别无年度计划
          totalPremium,
          totalClaim
      );

      const dataByBusinessType = this._aggregateByDimension(
          mappedData,
          'ui_short_label',
          '业务类型简称',
          null,  // 业务类型无年度计划
          totalPremium,
          totalClaim
      );

      // 5. 计算全局KPI
      const summary = this._calculateGlobalKPIs(dataByOrg);

      // 6. 检测问题机构
      const problems = this._detectProblems(dataByOrg);

      // 7. 组装最终对象
      return {
          summary,
          problems,
          dataByOrg,
          dataByCategory,
          dataByBusinessType
      };
  }

  ---
  四、实施步骤（遵循开发规范）

  阶段1：准备工作（1小时）

  步骤1.1：创建技术决策记录

  文件：开发文档/decisions/D002_JavaScript数据聚合逻辑对等实现.md
  内容：
  - 背景：静态部署需要前端完整实现数据聚合
  - 决策：将Python _process_dimension 逻辑完整移植到JavaScript
  - 方案：采用通用聚合方法+多维度调用的架构
  - 权衡：增加代码复杂度，但确保数据一致性
  - 影响范围：F006静态部署系统

  步骤1.2：读取Python后端完整逻辑

  任务：
  - 阅读 src/report_generator.py 的 _process_dimension 方法
  - 阅读 src/kpi_calculator.py 的 calculate_kpis 方法
  - 理解16个核心KPI的计算公式
  - 确认字段映射关系

  步骤1.3：确认数据依赖

  任务：
  - 确认 reference/business_type_mapping.json 结构
  - 确认 reference/year-plans.json 结构
  - 确认 reference/thresholds.json 中的阈值配置

  阶段2：代码实现（3-4小时）

  步骤2.1：实现业务类型映射方法

  文件：static/js/static-report-generator.js
  方法：_mapBusinessTypes(csvData)
  任务：
  - 读取 this.businessMapping（已加载）
  - 为每行数据添加 ui_short_label 字段
  - 处理未映射的业务类型（默认值）

  步骤2.2：实现通用聚合方法

  文件：static/js/static-report-generator.js
  方法：_aggregateByDimension(csvData, dimensionField, labelName, planMap, totalPremium, totalClaim)
  任务：
  - 按维度字段分组
  - 调用 _calculateKPIsForGroup 计算每组KPI
  - 计算占比（保费占比、赔款占比）
  - 关联年度计划（如果有）
  - 按签单保费降序排序

  步骤2.3：实现KPI计算方法

  文件：static/js/static-report-generator.js
  方法：_calculateKPIsForGroup(groupData, plan)
  任务：
  - 汇总基础数据（签单保费、满期保费、赔款等）
  - 计算满期赔付率 = 已报告赔款 / 满期保费 × 100
  - 计算费用率 = 费用额 / 签单保费 × 100
  - 计算变动成本率 = 满期赔付率 + 费用率
  - 计算出险率 = 赔案件数 / 保单件数 × 100
  - 计算案均赔款 = 已报告赔款 / 赔案件数
  - 计算年计划达成率（关联year-plans.json）

  步骤2.4：实现年度计划关联

  文件：static/js/static-report-generator.js
  方法：_loadYearPlans()
  任务：
  - 从 this.yearPlans 提取年度保费计划
  - 转换为 Map 结构（机构名 → 计划值）
  - 处理缺失计划的情况

  步骤2.5：重构现有方法

  文件：static/js/static-report-generator.js
  方法：transformToTemplateData(csvData)
  任务：
  - 删除临时代码（dataByCategory: dataByOrg）
  - 调用新的通用聚合方法
  - 确保返回完整的DATA结构

  阶段3：测试验证（1-2小时）

  步骤3.1：单元测试（本地）

  任务：
  - 使用天府CSV测试三级机构聚合
  - 使用四川分公司CSV测试多机构聚合
  - 验证客户类别维度数据
  - 验证业务类型维度数据
  - 对比Python后端生成的DATA对象

  步骤3.2：浏览器验证

  任务：
  - 本地启动HTTP服务器
  - 上传CSV文件
  - 检查控制台DATA对象
  - 切换维度验证数据正确性
  - 检查图表渲染

  步骤3.3：数据一致性验证

  工具：Python脚本对比
  # 生成Python版本DATA
  python main.py --csv data/test.csv --output python_data.json

  # 生成JavaScript版本DATA（从浏览器控制台复制）
  # 保存为 js_data.json

  # 对比差异
  python scripts/compare_data_output.py python_data.json js_data.json

  阶段4：文档更新（30分钟）

  步骤4.1：更新meta.json

  文件：开发文档/01_features/F006_static_deployment/meta.json
  修改：
  {
    "updated_at": "2025-12-15",
    "dependencies": ["F001", "F002", "F003", "F004", "F007"],
    "related_decisions": [
      "D001_ECharts-CDN加载优化.md",
      "D002_JavaScript数据聚合逻辑对等实现.md"
    ]
  }

  步骤4.2：更新DEVLOG.md

  文件：开发文档/reports/DEVLOG.md
  新增条目：
  ### 🎯 功能完善：实现完整的多维度数据聚合逻辑
  **摘要**: 将Python后端的数据聚合逻辑完整移植到JavaScript，实现三级机构、客户类别、业务类型三个维度的数据聚合和KPI计算。

  **主要变更**:
  1. 实现通用聚合方法 `_aggregateByDimension`
  2. 实现KPI计算方法 `_calculateKPIsForGroup`
  3. 实现业务类型映射 `_mapBusinessTypes`
  4. 实现年度计划关联 `_loadYearPlans`
  5. 重构 `transformToTemplateData` 方法

  **影响文件**:
  - `static/js/static-report-generator.js` [UPDATED] (+150行)

  **验证方式**:
  - 数据一致性对比：JavaScript生成DATA与Python后端100%一致
  - 多维度切换：三个维度数据正确显示
  - KPI计算准确：16个核心指标与后端一致

  **相关决策**: D002_JavaScript数据聚合逻辑对等实现.md

  步骤4.3：重新生成知识库索引

  命令：
  node "tools/update-docs.js"

  阶段5：Git提交与推送（30分钟）

  步骤5.1：提交代码

  # 检查修改
  git status

  # 添加文件
  git add static/js/static-report-generator.js
  git add 开发文档/01_features/F006_static_deployment/meta.json
  git add 开发文档/decisions/D002_JavaScript数据聚合逻辑对等实现.md
  git add 开发文档/reports/DEVLOG.md
  git add 开发文档/KNOWLEDGE_INDEX.md

  # 提交
  git commit -m "✨ 实现完整的多维度数据聚合逻辑（对等Python后端）

  - 新增通用聚合方法_aggregateByDimension（支持三个维度）
  - 实现完整的KPI计算逻辑（16个核心指标）
  - 实现业务类型映射和年度计划关联
  - 重构transformToTemplateData方法
  - 数据与Python后端100%对等

  影响功能：F006静态部署系统
  相关决策：D002
  验证：本地测试通过+浏览器验证通过"

  步骤5.2：推送前检查

  # 自动执行pre-push hook检查
  git push origin main

  步骤5.3：GitHub Actions验证

  任务：
  - 等待GitHub Actions部署完成（~3分钟）
  - 访问 https://alongor666.github.io/autowrKPI/
  - 上传CSV验证功能

  ---
  五、验收标准

  5.1 功能验收

  - 三级机构维度：数据聚合正确，KPI计算准确
  - 客户类别维度：数据聚合正确，支持维度切换
  - 业务类型维度：数据聚合正确，支持维度切换
  - 年计划达成率：正确关联year-plans.json，计算准确

  5.2 质量验收

  - 数据一致性：JavaScript生成的DATA对象与Python后端生成的差异 < 0.01%
  - 性能：3000行CSV处理时间 < 2秒
  - 代码质量：通过ESLint检查，无console.error

  5.3 文档验收

  - ADR记录：D002技术决策记录完整
  - DEVLOG更新：变更记录清晰
  - meta.json更新：依赖关系和决策关联正确
  - 索引更新：KNOWLEDGE_INDEX.md已重新生成

  ---
  六、风险与应对

  6.1 技术风险

  | 风险                 | 概率 | 影响 | 应对措施                            |
  |----------------------|------|------|-------------------------------------|
  | 字段映射不一致       | 中   | 高   | 详细对比Python/JS字段名，建立映射表 |
  | KPI计算公式偏差      | 低   | 高   | 单元测试验证每个公式                |
  | 性能问题（大数据量） | 低   | 中   | 分批处理或使用Web Worker            |
  | 年度计划数据缺失     | 中   | 中   | 提供默认值或跳过计算                |

  6.2 项目风险

  | 风险               | 概率 | 影响 | 应对措施                           |
  |--------------------|------|------|------------------------------------|
  | 实施时间超预期     | 中   | 中   | 优先实现核心功能，次要功能后续迭代 |
  | Python后端逻辑变更 | 低   | 高   | 建立自动化测试对比机制             |

  ---
  七、时间估算

  | 阶段            | 预计时间 | 说明                 |
  |-----------------|----------|----------------------|
  | 阶段1：准备工作 | 1小时    | 阅读代码+创建ADR     |
  | 阶段2：代码实现 | 3-4小时  | 核心逻辑实现         |
  | 阶段3：测试验证 | 1-2小时  | 单元测试+浏览器测试  |
  | 阶段4：文档更新 | 30分钟   | 更新meta.json+DEVLOG |
  | 阶段5：提交推送 | 30分钟   | Git操作+验证         |
  | 总计            | 6-8小时  | 预留1小时缓冲        |

  ---
  八、下一步行动

  立即行动（优先级P0）

  1. ✅ 创建技术决策记录 D002_JavaScript数据聚合逻辑对等实现.md
  2. ✅ 读取并理解Python后端 _process_dimension 逻辑
  3. ✅ 设计JavaScript实现架构

  今日完成（优先级P1）

  4. 🎯 实现 _mapBusinessTypes 方法
  5. 🎯 实现 _aggregateByDimension 通用方法
  6. 🎯 实现 _calculateKPIsForGroup KPI计算

  后续计划（优先级P2）

  7. 🎯 完整测试验证
  8. 🎯 更新文档并提交
