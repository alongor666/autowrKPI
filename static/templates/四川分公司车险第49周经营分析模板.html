<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>华安保险车险第49周经营分析 - 四川</title>
    <!-- 使用多个CDN源加载ECharts，确保在各种网络环境下都能正常加载 -->
    <script src="https://lib.baomitu.com/echarts/5.4.3/echarts.min.js" onerror="this.remove()"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js" onerror="this.remove()"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" onerror="console.error('ECharts加载失败，请检查网络连接')"></script>
    <style>
        /* 悬浮按钮样式 */
        .float-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(160, 39, 36, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            border: none;
        }

        .float-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 20px rgba(160, 39, 36, 0.6);
            background-color: #b92b27;
        }
        
        .float-btn svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        /* Tooltip */
        .float-btn::after {
            content: "导入新数据";
            position: absolute;
            right: 75px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.2s;
            pointer-events: none;
        }

        .float-btn:hover::after {
            opacity: 1;
            transform: translateX(0);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #a02724;
            --success-green: #00b050;
            --warning-yellow: #ffc000;
            --danger-red: #c00000;
            --gray-dark: #333333;
            --gray-medium: #666666;
            --gray-light: #cccccc;
            --background: #f5f5f5;

            /* macOS风格变量 */
            --blur-backdrop: blur(20px);
            --card-shadow: 0 2px 12px rgba(0,0,0,0.08);
            --card-shadow-hover: 0 4px 20px rgba(0,0,0,0.12);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ebef 100%);
            color: var(--gray-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: 600;
        }

        .header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--blur-backdrop);
            -webkit-backdrop-filter: var(--blur-backdrop);
            padding: 24px 48px;
            border-bottom: 1px solid rgba(160, 39, 36, 0.1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary-red);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-info {
            font-size: 13px;
            color: var(--gray-medium);
            font-weight: 600;
        }

        .tabs {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: var(--blur-backdrop);
            -webkit-backdrop-filter: var(--blur-backdrop);
            padding: 0 48px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            position: sticky;
            top: 76px;
            z-index: 99;
        }

        .tab {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-size: 15px;
            color: var(--gray-medium);
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            position: relative;
        }

        .tab:hover {
            background: rgba(160, 39, 36, 0.05);
            color: var(--gray-dark);
        }

        .tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
        }

        .content {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 40px;
        }

        .metric-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 28px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 1px solid rgba(0,0,0,0.04);
        }

        .metric-card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 13px;
            color: var(--gray-medium);
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .metric-value {
            font-size: 48px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', Arial, sans-serif;
            letter-spacing: -1.5px;
            line-height: 1.1;
        }

        .metric-unit {
            font-size: 18px;
            color: var(--gray-medium);
            margin-left: 6px;
            font-weight: 600;
        }

        .status-good { color: var(--success-green); }
        .status-warning { color: var(--warning-yellow); }
        .status-danger { color: var(--danger-red); }

        .dimension-switch {
            display: inline-flex;
            gap: 0;
            margin-bottom: 20px;
            background: rgba(160, 39, 36, 0.08);
            border-radius: 10px;
            padding: 3px;
        }

        .dimension-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            font-size: 14px;
            color: var(--gray-dark);
            font-weight: 500;
        }

        .dimension-btn:hover {
            background: rgba(160, 39, 36, 0.12);
        }

        .dimension-btn.active {
            background: white;
            color: var(--primary-red);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        /* 子标签页样式 */
        .sub-tabs {
            display: inline-flex;
            gap: 0;
            margin-bottom: 20px;
            background: rgba(160, 39, 36, 0.06);
            border-radius: 9px;
            padding: 3px;
        }

        .sub-tab {
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 7px;
            font-size: 13px;
            color: var(--gray-dark);
            background: transparent;
            border: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .sub-tab:hover {
            background: rgba(160, 39, 36, 0.1);
        }

        .sub-tab.active {
            background: white;
            color: var(--primary-red);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.04);
            transition: var(--transition);
        }

        .chart-container:hover {
            box-shadow: var(--card-shadow-hover);
        }

        .chart {
            width: 100%;
            height: 600px;
            min-height: 500px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-red);
            margin: 6px 0 12px 0;
            text-align: left;
        }

        .chart-body {
            margin-bottom: 16px;
            text-align: left;
        }

        .chart-body p {
            font-size: 14px;
            font-weight: 700;
            margin: 4px 0;
        }

        .ppt-slide {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 40px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            margin-top: 20px;
            overflow: visible;
            min-height: 600px;
        }
        
        .ppt-slide .chart-container {
            box-shadow: none;
            background: transparent;
            padding: 0;
            margin: 0;
            border: none;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .ppt-slide .chart {
            flex: 1;
            height: auto !important;
            width: 100%;
        }
        
        .ppt-slide .chart-title {
            margin-top: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .problem-list {
            background: linear-gradient(135deg, rgba(255, 192, 0, 0.08) 0%, rgba(255, 192, 0, 0.12) 100%);
            border-left: 3px solid var(--warning-yellow);
            padding: 20px 24px;
            margin-bottom: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(255, 192, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .problem-list h3 {
            font-size: 15px;
            color: var(--gray-dark);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .problem-list ul {
            list-style: none;
        }

        .problem-list li {
            padding: 6px 0;
            color: var(--gray-dark);
            font-size: 14px;
        }
        
        .error-banner {
            display: none;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .metric-cards {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .header, .tabs, .content {
                padding-left: 20px;
                padding-right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>四川分公司车险第49周经营分析</h1>
        <div class="header-info">
            数据截止日期：2025年12月06日
        </div>
    </div>

    <!-- 悬浮上传按钮 -->
    <a href="/" class="float-btn" title="导入新数据">
        <svg viewBox="0 0 24 24">
            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
        </svg>
    </a>

    <div class="tabs">
        <div class="tab active" data-tab="overview">经营概览</div>
        <div class="tab" data-tab="premium">保费进度</div>
        <div class="tab" data-tab="cost">变动成本</div>
        <div class="tab" data-tab="loss">损失暴露</div>
        <div class="tab" data-tab="expense">费用支出</div>
    </div>

    <div class="content">
        <div id="error-banner" class="error-banner"></div>
    
        <!-- 经营概览 -->
        <div id="tab-overview" class="tab-content active">
            <div class="dimension-switch">
                <button class="dimension-btn active" onclick="switchDimension('overview', 'kpi')">关键数据</button>
                <button class="dimension-btn" onclick="switchDimension('overview', 'org')">三级机构</button>
                <button class="dimension-btn" onclick="switchDimension('overview', 'category')">客户类别</button>
                <button class="dimension-btn" onclick="switchDimension('overview', 'businessType')">业务类型</button>
            </div>

            <div id="overview-kpi-content">
                <div id="kpi-alert-title" style="font-size:16px;color:#a02724;margin-bottom:12px;font-weight:700;text-align:left;"></div>
                <div class="metric-cards">
                    <div class="metric-card">
                        <div class="metric-label">保费时间进度达成率</div>
                        <div class="metric-value" id="metric-progress">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">变动成本率</div>
                        <div class="metric-value" id="metric-cost-rate">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">满期赔付率</div>
                        <div class="metric-value" id="metric-claim-rate">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">费用率</div>
                        <div class="metric-value" id="metric-expense-rate">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">签单保费</div>
                        <div class="metric-value" id="metric-premium">--<span class="metric-unit">万元</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">边际贡献额</div>
                        <div class="metric-value" id="metric-margin">--<span class="metric-unit">万元</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">已报告赔款</div>
                        <div class="metric-value" id="metric-claim">--<span class="metric-unit">万元</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">费用金额</div>
                        <div class="metric-value" id="metric-expense">--<span class="metric-unit">万元</span></div>
                    </div>
                </div>
            </div>

            <div id="overview-chart-content" style="display:none;">
                <div class="ppt-slide">
                    <div class="chart-title" id="title-overview"></div>
                    <div class="chart-body" id="body-overview"></div>

                    <div class="chart-container">
                        <div id="chart-overview" class="chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 其他标签页内容 -->
        <div id="tab-premium" class="tab-content">
            <div class="dimension-switch">
                <button class="dimension-btn active" onclick="switchDimension('premium', 'org')">三级机构</button>
                <button class="dimension-btn" onclick="switchDimension('premium', 'category')">客户类别</button>
                <button class="dimension-btn" onclick="switchDimension('premium', 'businessType')">业务类型</button>
            </div>
            <div class="ppt-slide">
                <div class="chart-title" id="title-premium"></div>
                <div class="chart-body" id="body-premium"></div>
                <div class="chart-container">
                    <div id="chart-premium" class="chart"></div>
                </div>
            </div>
        </div>

        <div id="tab-cost" class="tab-content">
            <div class="dimension-switch">
                <button class="dimension-btn active" onclick="switchDimension('cost', 'org')">三级机构</button>
                <button class="dimension-btn" onclick="switchDimension('cost', 'category')">客户类别</button>
                <button class="dimension-btn" onclick="switchDimension('cost', 'businessType')">业务类型</button>
            </div>
            <div class="ppt-slide">
                <div class="chart-title" id="title-cost"></div>
                <div class="chart-body" id="body-cost"></div>
                <div class="chart-container">
                    <div id="chart-cost" class="chart"></div>
                </div>
            </div>
        </div>

        <div id="tab-loss" class="tab-content">
            <div class="dimension-switch">
                <button class="dimension-btn active" onclick="switchDimension('loss', 'org')">三级机构</button>
                <button class="dimension-btn" onclick="switchDimension('loss', 'category')">客户类别</button>
                <button class="dimension-btn" onclick="switchDimension('loss', 'businessType')">业务类型</button>
            </div>
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubTab('loss', 'bubble')">赔付VS占比</div>
                <div class="sub-tab" onclick="switchSubTab('loss', 'quadrant')">频度VS额度</div>
            </div>

            <div class="ppt-slide">
                <div class="chart-title" id="title-loss"></div>
                <div class="chart-body" id="body-loss"></div>
                
                <div class="chart-container">
                    <div id="chart-loss" class="chart"></div>
                </div>
            </div>
        </div>

        <div id="tab-expense" class="tab-content">
            <div class="dimension-switch">
                <button class="dimension-btn active" onclick="switchDimension('expense', 'org')">三级机构</button>
                <button class="dimension-btn" onclick="switchDimension('expense', 'category')">客户类别</button>
                <button class="dimension-btn" onclick="switchDimension('expense', 'businessType')">业务类型</button>
            </div>
            <div class="ppt-slide">
                <div class="chart-title" id="title-expense"></div>
                <div class="chart-body" id="body-expense"></div>
                <div class="chart-container">
                    <div id="chart-expense" class="chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            const banner = document.getElementById('error-banner');
            banner.style.display = 'block';
            banner.innerHTML = `<strong>发生错误:</strong> ${message}<br><small>${source}:${lineno}</small>`;
            console.error('Global error:', error);
            return false;
        };

        // 数据
        // 数据对象将由CSV上传动态生成，严禁硬编码示例数据
        // DATA对象由 static-report-generator.js 的 generateHTML 方法注入
        let DATA = {}; // 占位符，将在报告生成时被实际数据替换


        // ==================== 气泡图优化辅助函数 ====================

        /**
         * 根据变动成本率获取对应的状态颜色（5级）
         * 卓越 < 85%, 优秀 85-88%, 健康 88-91%, 预警 91-94%, 危险 94-97%+
         */
        function getStatusColor(variableCostRate) {
            if (variableCostRate < 85) {
                return '#00b050'; // 卓越 - 深绿
            } else if (variableCostRate < 88) {
                return '#92d050'; // 优秀 - 浅绿
            } else if (variableCostRate < 91) {
                return '#0070c0'; // 健康 - 蓝色
            } else if (variableCostRate < 94) {
                return '#ffc000'; // 预警 - 黄色
            } else {
                return '#c00000'; // 危险 - 红色
            }
        }

        /**
         * 根据变动成本率获取状态名称
         */
        function getStatusName(variableCostRate) {
            if (variableCostRate < 85) return '卓越';
            else if (variableCostRate < 88) return '优秀';
            else if (variableCostRate < 91) return '健康';
            else if (variableCostRate < 94) return '预警';
            else return '危险';
        }

        /**
         * 计算气泡大小，确保：
         * 1. 最小气泡直径最多是最大气泡的1/2
         * 2. 限制最大气泡大小（maxSize）
         * 3. 技术性压缩（使用平方根缩放）
         */
        function calculateBubbleSize(values, dataIndex) {
            // 获取所有值
            const allValues = values.map(v => v || 0);
            const currentValue = allValues[dataIndex] || 0;

            // 计算最大最小值
            const maxValue = Math.max(...allValues);
            const minValue = Math.min(...allValues.filter(v => v > 0)); // 排除0值

            // 配置参数
            const maxSize = 50; // 最大气泡大小
            const minSize = maxSize / 2; // 最小气泡大小（最大的1/2）

            // 避免除以0
            if (maxValue === 0 || maxValue === minValue) {
                return maxSize;
            }

            // 使用平方根进行技术性压缩，使差异更温和
            const normalizedValue = Math.sqrt(currentValue / maxValue);

            // 映射到 [minSize, maxSize] 范围
            const size = minSize + (maxSize - minSize) * normalizedValue;

            return Math.max(minSize, Math.min(maxSize, size));
        }

        /**
         * 为数据数组创建气泡大小计算函数
         */
        function createBubbleSizeCalculator(data, valueField) {
            const values = data.map(d => d[valueField] || 0);
            return (d) => {
                const index = data.findIndex(item => item === d);
                return calculateBubbleSize(values, index);
            };
        }

        /**
         * 根据指标类型和值获取颜色强度
         * @param {string} indicatorName - 指标名称
         * @param {number} value - 指标值
         * @param {Array} allValues - 所有值的数组
         * @param {boolean} isPositive - 是否为正向指标
         */
        function getIndicatorColorIntensity(indicatorName, value, allValues, isPositive) {
            if (!allValues || allValues.length === 0) return 0;

            const maxValue = Math.max(...allValues);
            const minValue = Math.min(...allValues);

            if (maxValue === minValue) return 0.5; // 所有值相同时返回中间色

            // 计算归一化位置 (0-1)
            let normalizedPosition = (value - minValue) / (maxValue - minValue);

            // 对于逆向指标，反转位置（值越大，颜色越浅）
            if (!isPositive) {
                normalizedPosition = 1 - normalizedPosition;
            }

            return normalizedPosition;
        }

        /**
         * 获取指标值的颜色
         * 正向指标：值越大颜色越绿（越好）
         * 逆向指标：值越大颜色越红（越差）
         * 统一使用5级状态颜色（文字颜色）
         */
        function getIndicatorColor(indicatorName, value, allValues) {
            // 如果是变动成本率，直接使用统一的状态颜色规则（绝对阈值）
            if (indicatorName === '变动成本率') {
                return getStatusColor(value);
            }

            // 定义正向和逆向指标
            const positiveIndicators = ['边际贡献率', '年计划达成率'];
            
            const isPositive = positiveIndicators.includes(indicatorName);
            const intensity = getIndicatorColorIntensity(indicatorName, value, allValues, isPositive);

            // 根据强度（0-1，越大越好）映射到5级状态颜色
            // 卓越深绿: #00b050 (0.8-1.0)
            // 优秀绿: #92d050 (0.6-0.8)
            // 健康蓝: #0070c0 (0.4-0.6)
            // 预警黄: #ffc000 (0.2-0.4)
            // 危险红: #c00000 (0.0-0.2)
            
            if (intensity < 0.2) {
                return '#c00000'; // 危险 - 红色
            } else if (intensity < 0.4) {
                return '#ffc000'; // 预警 - 黄色
            } else if (intensity < 0.6) {
                return '#0070c0'; // 健康 - 蓝色
            } else if (intensity < 0.8) {
                return '#92d050'; // 优秀 - 浅绿
            } else {
                return '#00b050'; // 卓越 - 深绿
            }
        }

        /**
         * 生成气泡图下方的指标表格HTML
         */
        function generateIndicatorTable(data, dimField, indicators) {
            if (!data || data.length === 0) return '';

            let html = '<div class="indicator-table-container" style="margin-top: 20px; overflow-x: auto;">';
            html += '<table class="indicator-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">';

            // 表头
            html += '<thead><tr style="background-color: #f5f5f5;">';
            html += `<th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${dimField}</th>`;
            indicators.forEach(indicator => {
                html += `<th style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${indicator}</th>`;
            });
            html += '</tr></thead>';

            // 表体
            html += '<tbody>';
            data.forEach(d => {
                html += '<tr>';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${d[dimField]}</td>`;

                indicators.forEach(indicator => {
                    const value = d[indicator];
                    const allValues = data.map(item => item[indicator]);
                    const color = getIndicatorColor(indicator, value, allValues);
                    const isPercentage = ['变动成本率', '费用率', '满期赔付率', '出险率', '年计划达成率', '边际贡献率'].includes(indicator);
                    const displayValue = isPercentage ? `${value.toFixed(1)}%` : Math.round(value).toLocaleString();

                    html += `<td style="padding: 8px; border: 1px solid #ddd; color: ${color}; font-weight: bold;">${displayValue}</td>`;
                });

                html += '</tr>';
            });
            html += '</tbody>';

            html += '</table>';
            html += '</div>';

            return html;
        }

        // 当前维度
        let currentDimensions = {
            overview: 'kpi',
            premium: 'org',
            cost: 'org',
            loss: 'org',
            expense: 'org'
        };
        
        // 当前子标签页
        let currentSubTab = {
            loss: 'bubble'
        };

        // 标签页切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                try {
                    const tabName = tab.dataset.tab;

                    // 更新标签样式
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // 更新内容显示
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${tabName}`).classList.add('active');

                    // 渲染图表
                    renderChart(tabName);
                } catch (e) {
                    console.error('Tab switch error:', e);
                    document.getElementById('error-banner').style.display = 'block';
                    document.getElementById('error-banner').innerText = '切换标签页时出错: ' + e.message;
                }
            });
        });

        // 维度切换
        function switchDimension(tab, dimension) {
            try {
                currentDimensions[tab] = dimension;

                // 更新按钮样式
                const container = document.querySelector(`#tab-${tab} .dimension-switch`);
                container.querySelectorAll('.dimension-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                // 经营概览特殊处理
                if (tab === 'overview') {
                    const kpiContent = document.getElementById('overview-kpi-content');
                    const chartContent = document.getElementById('overview-chart-content');
                    if (dimension === 'kpi') {
                        if (kpiContent) kpiContent.style.display = 'block';
                        if (chartContent) chartContent.style.display = 'none';
                        return; // 不需要渲染图表
                    } else {
                        if (kpiContent) kpiContent.style.display = 'none';
                        if (chartContent) chartContent.style.display = 'block';
                    }
                }

                // 重新渲染图表
                renderChart(tab);
            } catch (e) {
                console.error('Dimension switch error:', e);
                alert('切换维度出错: ' + e.message);
            }
        }
        
        // 子标签页切换
        function switchSubTab(tab, subTab) {
            try {
                currentSubTab[tab] = subTab;
                
                // 更新按钮样式
                const container = document.querySelector(`#tab-${tab} .sub-tabs`);
                container.querySelectorAll('.sub-tab').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // 重新渲染图表
                renderChart(tab);
            } catch (e) {
                console.error('Sub-tab switch error:', e);
                alert('切换视图出错: ' + e.message);
            }
        }

        // 渲染图表
        function renderChart(tab) {
            try {
                const dimension = currentDimensions[tab];
                // 经营概览 - KPI模式不渲染图表
                if (tab === 'overview' && dimension === 'kpi') return;

                let data, dimField;

                if (dimension === 'org') {
                    data = DATA.dataByOrg;
                    dimField = '机构';
                } else if (dimension === 'category') {
                    data = DATA.dataByCategory;
                    dimField = '客户类别';
                } else if (dimension === 'businessType') {
                    data = DATA.dataByBusinessType;
                    dimField = '业务类型简称';
                } else {
                    data = DATA.dataByOrg;
                    dimField = '机构';
                }

                // 克隆数据以避免修改原始数据
                data = [...data];

                if (dimension === 'org') {
                    data = data.filter(d => d[dimField] !== '本部');
                }

                // 排序逻辑：从差到好
                if (tab === 'overview' || tab === 'cost') {
                    // 变动成本率：高 -> 低 (差 -> 好)
                    data.sort((a, b) => (b.变动成本率 || 0) - (a.变动成本率 || 0));
                } else if (tab === 'premium') {
                    // 年计划达成率：低 -> 高 (差 -> 好)
                    const hasPlan = data.some(d => d.年计划达成率 != null);
                    if (hasPlan) {
                        data.sort((a, b) => (a.年计划达成率 || 0) - (b.年计划达成率 || 0));
                    } else {
                        data.sort((a, b) => (a.签单保费 || 0) - (b.签单保费 || 0));
                    }
                } else if (tab === 'loss') {
                    // 满期赔付率：高 -> 低 (差 -> 好)
                    data.sort((a, b) => (b.满期赔付率 || 0) - (a.满期赔付率 || 0));
                } else if (tab === 'expense') {
                    // 费用率：高 -> 低 (差 -> 好)
                    data.sort((a, b) => (b.费用率 || 0) - (a.费用率 || 0));
                }

                if (dimension === 'org') {
                    data = data.slice(0, 12);
                }

                const chartDom = document.getElementById(`chart-${tab}`);
                if (!chartDom) return;
                
                // 确保 echarts 已加载
                if (typeof echarts === 'undefined') {
                    throw new Error('图表库加载失败，请检查网络连接');
                }
                
                // 销毁旧实例以避免冲突
                const oldChart = echarts.getInstanceByDom(chartDom);
                if (oldChart) {
                    oldChart.dispose();
                }
                
                const chart = echarts.init(chartDom);

                let option;

                const getAxisLabelStyle = (categoriesLen) => {
                    const base = 14;
                    const computed = Math.max(10, Math.min(base, Math.floor(chartDom.clientWidth / Math.max(8, categoriesLen * 8))));
                    return { fontWeight: 'bold', fontSize: computed, rotate: 0, interval: 0, hideOverlap: true, overflow: 'truncate' };
                };

                const renderTitleAndBody = () => {
                    const titleEl = document.getElementById(`title-${tab}`);
                    const bodyEl = document.getElementById(`body-${tab}`);
                    if (!titleEl || !bodyEl) return;
                    const dim = currentDimensions[tab];
                    const tabLabelMap = { overview: '经营概览', premium: '保费进度', cost: '变动成本', loss: '损失暴露', expense: '费用支出' };
                    const dimLabelMap = { org: '三级机构', category: '客户类别', businessType: '业务类型' };
                    const subTabLabelMapLoss = { bubble: '赔付VS占比', quadrant: '频度VS额度' };
                    let title = '';
                    let body = [];
                    if (tab === 'overview') {
                        const thr = DATA.thresholds || {};
                        const base = thr['四象限基准线'] || {};
                        const planFail = (thr['问题机构识别阈值'] || {})['年保费未达标'] || 95;
                        if (dim === 'org') {
                            const namesTitle = data.filter(d => (d.年计划达成率 || 0) < planFail && (d.变动成本率 || 0) >= 100).map(d => d[dimField]);
                            const namesSuperProfit = data.filter(d => (d.年计划达成率 || 0) >= 100 && (d.变动成本率 || 0) < 100).map(d => d[dimField]);
                            const namesSuperLoss = data.filter(d => (d.年计划达成率 || 0) >= 100 && (d.变动成本率 || 0) >= 100).map(d => d[dimField]);
                            const namesProfitLag = data.filter(d => (d.变动成本率 || 0) < 100 && (d.年计划达成率 || 0) < planFail).map(d => d[dimField]);
                            title = '进度落后且亏损机构有' + (namesTitle.length ? namesTitle.join('、') : '无');
                            body = [
                                '1. 超进度且盈利机构' + (namesSuperProfit.length ? '：' + namesSuperProfit.join('、') : '：无'),
                                '2. 超进度但亏损机构' + (namesSuperLoss.length ? '：' + namesSuperLoss.join('、') : '：无'),
                                '3. 盈利但进度落后机构' + (namesProfitLag.length ? '：' + namesProfitLag.join('、') : '：无')
                            ];
                        } else if (dim === 'category') {
                            const vcThr = (base['变动成本率'] || 88);
                            const names = data.filter(d => (d.变动成本率 || 0) >= vcThr).map(d => d[dimField]);
                            title = '变动成本率超预警线的客户类别有' + (names.length ? names.join('、') : '无');
                            body = [];
                        } else if (dim === 'businessType') {
                            const vcThr = (base['变动成本率'] || 88);
                            const names = data.filter(d => (d.变动成本率 || 0) >= vcThr).map(d => d[dimField]);
                            title = '变动成本率超预警线的业务类型有' + (names.length ? names.join('、') : '无');
                            body = [];
                        }
                    } else if (tab === 'premium') {
                        if (DATA.isSingleOrgMode && (dim === 'category' || dim === 'businessType')) {
                            // Single Org Mode Logic for Category/Business Type
                            const zeroList = data.filter(d => (d.签单保费 || 0) <= 0).map(d => d[dimField]);
                            title = '保费为0的' + dimLabelMap[dim] + '有' + (zeroList.length ? zeroList.join('、') : '无');
                            
                            const top3 = [...data].filter(d => (d.签单保费 || 0) > 0)
                                .sort((a, b) => (b.签单保费 || 0) - (a.签单保费 || 0))
                                .slice(0, 3)
                                .map(d => d[dimField]);
                            body = ['1. 规模前三的' + dimLabelMap[dim] + (top3.length ? '：' + top3.join('、') : '：无')];
                        } else {
                            // Standard/Branch Mode Logic
                            if (dim === 'org') {
                                const low90 = data.filter(d => (d.年计划达成率 || 0) < 90).map(d => d[dimField]);
                                const mid = data.filter(d => (d.年计划达成率 || 0) >= 90 && (d.年计划达成率 || 0) < 100).map(d => d[dimField]);
                                const high = data.filter(d => (d.年计划达成率 || 0) >= 100).map(d => d[dimField]);
                                title = '低于90%的三级机构有' + (low90.length ? low90.join('、') : '无');
                                body = [
                                    '1. 90%–100% 的三级机构' + (mid.length ? '：' + mid.join('、') : '：无'),
                                    '2. 100% 以上的三级机构' + (high.length ? '：' + high.join('、') : '：无')
                                ];
                            } else if (dim === 'category') {
                                const lowList = data.filter(d => (d.签单保费 || 0) < 1000000).map(d => `${d[dimField]}`);
                                title = '低于100万的客户类别及保费有' + (lowList.length ? lowList.join('、') : '无');
                                const highList = data.filter(d => (d.签单保费 || 0) >= 1000000).map(d => d[dimField]);
                                body = ['1. 超100万的客户类别' + (highList.length ? '：' + highList.join('、') : '：无')];
                            } else if (dim === 'businessType') {
                                const lowList = data.filter(d => (d.签单保费 || 0) < 5000000).map(d => `${d[dimField]}`);
                                title = '低于500万的业务类型及保费有' + (lowList.length ? lowList.join('、') : '无');
                                const highList = data.filter(d => (d.签单保费 || 0) >= 5000000).map(d => d[dimField]);
                                body = ['1. 超500万的业务类型' + (highList.length ? '：' + highList.join('、') : '：无')];
                            }
                        }
                    } else if (tab === 'cost') {
                        const thr = DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线'] : {};
                        const paidThr = thr['满期赔付率'] || 70;
                        const feeThr = thr['费用率'] || 14;
                        const noun = dim === 'org' ? '三级机构' : (dim === 'category' ? '客户类别' : '业务类型');
                        const namesHH = data.filter(d => (d.满期赔付率 || 0) >= paidThr && (d.费用率 || 0) >= feeThr).map(d => d[dimField]);
                        const namesHL = data.filter(d => (d.满期赔付率 || 0) >= paidThr && (d.费用率 || 0) < feeThr).map(d => d[dimField]);
                        const namesLH = data.filter(d => (d.满期赔付率 || 0) < paidThr && (d.费用率 || 0) >= feeThr).map(d => d[dimField]);
                        const namesLL = data.filter(d => (d.满期赔付率 || 0) < paidThr && (d.费用率 || 0) < feeThr).map(d => d[dimField]);
                        title = '高赔付高费用' + noun + '有' + (namesHH.length ? namesHH.join('、') : '无');
                        body = [
                            '1. 高赔付低费用' + noun + (namesHL.length ? '：' + namesHL.join('、') : '：无'),
                            '2. 高费用低赔付' + noun + (namesLH.length ? '：' + namesLH.join('、') : '：无'),
                            '3. 低赔付低费用' + noun + (namesLL.length ? '：' + namesLL.join('、') : '：无')
                        ];
                    } else if (tab === 'loss') {
                        const subTab = currentSubTab['loss'] || 'bubble';
                        const noun = dim === 'org' ? '机构' : (dim === 'category' ? '客户类别' : '业务类型');
                        if (subTab === 'bubble') {
                            const paidThr = (DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线']['满期赔付率'] : 70);
                            const shareMean = data.reduce((s, d) => s + (d.已报告赔款占比 || 0), 0) / Math.max(1, data.length);
                            const namesHH = data.filter(d => d.满期赔付率 >= paidThr && d.已报告赔款占比 >= shareMean).map(d => d[dimField]);
                            const namesLH = data.filter(d => d.满期赔付率 < paidThr && d.已报告赔款占比 >= shareMean).map(d => d[dimField]);
                            const namesHL = data.filter(d => d.满期赔付率 >= paidThr && d.已报告赔款占比 < shareMean).map(d => d[dimField]);
                            const namesLL = data.filter(d => d.满期赔付率 < paidThr && d.已报告赔款占比 < shareMean).map(d => d[dimField]);
                            title = `损失暴露分析：高赔付高占比${noun}有` + (namesHH.length ? namesHH.join('、') : '无');
                            body = [
                                '1. 高占比低赔付' + noun + (namesLH.length ? '：' + namesLH.join('、') : '：无'),
                                '2. 高赔付低占比' + noun + (namesHL.length ? '：' + namesHL.join('、') : '：无'),
                                '3. 低赔付低占比' + noun + (namesLL.length ? '：' + namesLL.join('、') : '：无')
                            ];
                        } else {
                            const freqThr = (DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线']['出险率'] : 20);
                            const amtThr = (DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线']['案均赔款'] : 4500);
                            const namesHH = data.filter(d => d.出险率 >= freqThr && d.案均赔款 >= amtThr).map(d => d[dimField]);
                            const namesLH = data.filter(d => d.出险率 < freqThr && d.案均赔款 >= amtThr).map(d => d[dimField]);
                            const namesHL = data.filter(d => d.出险率 >= freqThr && d.案均赔款 < amtThr).map(d => d[dimField]);
                            const namesLL = data.filter(d => d.出险率 < freqThr && d.案均赔款 < amtThr).map(d => d[dimField]);
                            title = `损失暴露分析：高频高额${noun}有` + (namesHH.length ? namesHH.join('、') : '无');
                            body = [
                                '1. 高频低额' + noun + (namesHL.length ? '：' + namesHL.join('、') : '：无'),
                                '2. 低频高额' + noun + (namesLH.length ? '：' + namesLH.join('、') : '：无'),
                                '3. 低频低额' + noun + (namesLL.length ? '：' + namesLL.join('、') : '：无')
                            ];
                        }
                    } else if (tab === 'expense') {
                        const thr = DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线'] : {};
                        const feeThr = thr['费用率'] || 14;
                        const noun = dim === 'org' ? '三级机构' : (dim === 'category' ? '客户类别' : '业务类型');
                        const totalPremium = data.reduce((sum, item) => sum + (item.签单保费 || 0), 0);
                        const totalExpense = data.reduce((sum, item) => sum + ((item.签单保费 || 0) * (item.费用率 || 0) / 100), 0);
                        const calcShares = d => {
                            const expenseShare = totalExpense > 0 ? ((d.签单保费 || 0) * (d.费用率 || 0) / 100) / totalExpense * 100 : 0;
                            const premiumShare = d.保费占比 || (totalPremium > 0 ? (d.签单保费 || 0) / totalPremium * 100 : 0);
                            return { expenseShare, premiumShare, diff: expenseShare - premiumShare };
                        };
                        const namesHH = data.filter(d => (d.费用率 || 0) >= feeThr && calcShares(d).expenseShare >= calcShares(d).premiumShare).map(d => d[dimField]);
                        const namesHL = data.filter(d => (d.费用率 || 0) >= feeThr && calcShares(d).expenseShare < calcShares(d).premiumShare).map(d => d[dimField]);
                        const namesLH = data.filter(d => (d.费用率 || 0) < feeThr && calcShares(d).expenseShare >= calcShares(d).premiumShare).map(d => d[dimField]);
                        const namesLL = data.filter(d => (d.费用率 || 0) < feeThr && calcShares(d).expenseShare < calcShares(d).premiumShare).map(d => d[dimField]);
                        title = '高费用率高占比' + noun + '有' + (namesHH.length ? namesHH.join('、') : '无');
                        body = [
                            '1. 高费用率低占比' + noun + (namesHL.length ? '：' + namesHL.join('、') : '：无'),
                            '2. 高占比低费用率' + noun + (namesLH.length ? '：' + namesLH.join('、') : '：无'),
                            '3. 低费用率低占比' + noun + (namesLL.length ? '：' + namesLL.join('、') : '：无')
                        ];
                    }
                    const tabLabel = tabLabelMap[tab] || tab;
                    const dimLabelText = dimLabelMap[dim] || '';
                    const subLabel = tab === 'loss' ? (subTabLabelMapLoss[currentSubTab['loss'] || 'bubble'] || '') : '';
                    const prefix = tabLabel + (subLabel ? `（${subLabel}）` : '') + (dimLabelText ? `（${dimLabelText}）` : '');
                    const normalizedTitle = title.replace('损失暴露分析：', '').replace('有', '：');
                    titleEl.textContent = prefix + '——' + normalizedTitle;
                    bodyEl.innerHTML = body.map(t => `<p>${t}</p>`).join('');
                };

                renderTitleAndBody();

                // Filter out zero items for Chart in Single Org Mode
                if (DATA.isSingleOrgMode && tab === 'premium' && (dimension === 'category' || dimension === 'businessType')) {
                     data = data.filter(d => (d.签单保费 || 0) > 0);
                }

                if (tab === 'overview') {
                    // 经营概览 - 检查是否有年计划达成率数据
                    const hasYearPlan = data.some(d => d.年计划达成率 !== null && d.年计划达成率 !== undefined);

                    if (hasYearPlan) {
                        // 四象限散点图：年计划达成率 vs 变动成本率
                        option = {
                            grid: {
                                left: '5%',
                                right: '15%',
                                bottom: '10%',
                                top: '5%',
                                containLabel: true
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: params => {
                                    const d = params.data;
                                    return `${d.name}<br/>
                                           年计划达成率: ${d.value[0].toFixed(1)}%<br/>
                                           变动成本率: ${d.value[1].toFixed(1)}%<br/>
                                           签单保费: ${Math.round(d.value[2]/10000)}万元`;
                                }
                            },
                            xAxis: {
                                name: '年计划达成率 (%)',
                                nameLocation: 'middle',
                                nameGap: 30,
                                splitLine: { show: false },
                                min: 0,
                                max: 130,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            yAxis: {
                                name: '变动成本率 (%)',
                                nameLocation: 'middle',
                                nameGap: 40,
                                splitLine: { show: false },
                                min: 0,
                                max: 130,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            series: [{
                                type: 'scatter',
                                symbolSize: (value, params) => {
                                    const filteredData = data.filter(d => d.年计划达成率);
                                    const values = filteredData.map(d => d.签单保费 || 0);
                                    const dataIndex = params.dataIndex;
                                    return calculateBubbleSize(values, dataIndex);
                                },
                                data: data.filter(d => d.年计划达成率).map(d => ({
                                    name: d[dimField],
                                    value: [d.年计划达成率, d.变动成本率, d.签单保费, d.变动成本率],
                                    itemStyle: {
                                        color: getStatusColor(d.变动成本率)
                                    }
                                })),
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: params => `${params.data.name} ${params.data.value[3].toFixed(1)}%`,
                                    fontSize: 10,
                                    fontWeight: 'bold',
                                    color: 'white',
                                    textBorderColor: 'black',
                                    textBorderWidth: 2
                                },
                                labelLayout: { hideOverlap: true },
                                markLine: {
                                    silent: true,
                                    lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                    data: [
                                        { xAxis: 100 },
                                        { yAxis: 90 }
                                    ]
                                }
                            }]
                        };
                    } else {
                        // 无计划数据 - 使用保费占比 vs 变动成本率
                        const sortedData = [...data].sort((a, b) => b.变动成本率 - a.变动成本率);
                        option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: params => {
                                    const name = params[0].name;
                                    const idx = sortedData.findIndex(d => d[dimField] === name);
                                    const item = sortedData[idx];
                                    return `${name}<br/>
                                           变动成本率: ${item.变动成本率.toFixed(1)}%<br/>
                                           签单保费: ${Math.round(item.签单保费/10000)}万元<br/>
                                           保费占比: ${item.保费占比.toFixed(1)}%`;
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                data: sortedData.map(d => d[dimField]),
                                axisLabel: getAxisLabelStyle(sortedData.length)
                            },
                            yAxis: {
                                type: 'value',
                                name: '变动成本率 (%)',
                                axisLine: { show: true },
                                axisLabel: { fontWeight: 'bold' },
                                min: 0,
                                max: 130,
                                splitLine: { show: false }
                            },
                            series: [{
                                name: '变动成本率',
                                type: 'bar',
                                data: sortedData.map(d => ({
                                    value: parseFloat(d.变动成本率.toFixed(1)),
                                    itemStyle: {
                                        color: getStatusColor(d.变动成本率)
                                    }
                                })),
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: params => `${params.value.toFixed(1)}%`,
                                    fontSize: 10
                                },
                                markLine: {
                                    silent: true,
                                    lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                    data: [{ yAxis: 90, label: { formatter: '成本率基准: 90%' } }]
                                }
                            }]
                        };
                    }
                } else if (tab === 'cost') {
                    // 满期赔付率 vs 费用率（气泡大小：满期赔付率）
                    option = {
                        grid: {
                            left: '5%',
                            right: '15%',
                            bottom: '10%',
                            top: '5%',
                            containLabel: true
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => {
                                const d = params.data;
                                return `${d.name}<br/>
                                       满期赔付率: ${d.value[0].toFixed(1)}%<br/>
                                       费用率: ${d.value[1].toFixed(1)}%<br/>
                                       变动成本率: ${d.value[2].toFixed(1)}%<br/>
                                       保费占比: ${d.value[3].toFixed(1)}%`;
                            }
                        },
                        xAxis: {
                            name: '满期赔付率 (%)',
                            nameLocation: 'middle',
                            nameGap: 30,
                            splitLine: { show: false },
                            min: 0,
                            max: 130,
                            axisLabel: { fontWeight: 'bold' }
                        },
                        yAxis: {
                            name: '费用率 (%)',
                            nameLocation: 'middle',
                            nameGap: 40,
                            splitLine: { show: false },
                            min: 0,
                            max: 30,
                            axisLabel: { fontWeight: 'bold' }
                        },
                        series: [{
                            type: 'scatter',
                            symbolSize: (value, params) => {
                                const values = data.map(d => d.签单保费 || 0);
                                const dataIndex = params.dataIndex;
                                return calculateBubbleSize(values, dataIndex);
                            },
                            data: data.map(d => ({
                                name: d[dimField],
                                value: [d.满期赔付率, d.费用率, d.变动成本率, d.保费占比],
                                itemStyle: {
                                    color: getStatusColor(d.变动成本率)
                                }
                            })),
                            label: {
                                show: true,
                                position: 'inside',
                                formatter: params => {
                                    const name = params.data.name;
                                    const paidRate = params.data.value[0].toFixed(1);
                                    const expenseRate = params.data.value[1].toFixed(1);
                                    const costRate = params.data.value[2].toFixed(1);
                                    return `{b|${name}} ${paidRate}% | ${expenseRate}% | ${costRate}%`;
                                },
                                fontSize: 10,
                                color: params => {
                                    const costRate = params.data.value[2];
                                    const threshold = DATA.thresholds['问题机构识别阈值']['变动成本率超标'];
                                    return costRate > threshold ? '#d32f2f' : 'white';
                                },
                                textBorderColor: params => {
                                    const costRate = params.data.value[2];
                                    const threshold = DATA.thresholds['问题机构识别阈值']['变动成本率超标'];
                                    return costRate > threshold ? '#8b0000' : 'black';
                                },
                                textBorderWidth: 2,
                                rich: {
                                    b: { fontWeight: 'bold' }
                                }
                            },
                            labelLayout: { hideOverlap: true },
                            markLine: {
                                silent: true,
                                lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                data: [
                                    { xAxis: DATA.thresholds['四象限基准线']['满期赔付率'] },
                                    { yAxis: DATA.thresholds['四象限基准线']['费用率'] }
                                ]
                            }
                        }]
                    };
                } else if (tab === 'premium') {
                    // 保费进度 - 检查是否有年计划达成率数据
                    const premiumData = data.filter(d => d.年计划达成率 !== null && d.年计划达成率 !== undefined);

                    if (premiumData.length > 0) {
                        // 有计划数据 - 显示年计划达成率柱状图（从低到高排序）
                        premiumData.sort((a, b) => a.年计划达成率 - b.年计划达成率);
                        option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: params => {
                                const p = params[0];
                                const index = p.dataIndex;
                                const item = premiumData[index];
                                return `${item[dimField]}<br/>
                                   年计划达成率: ${item.年计划达成率.toFixed(1)}%<br/>
                                   签单保费: ${Math.round(item.签单保费/10000)}万元`;
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '15%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: premiumData.map(d => d[dimField]),
                            axisLabel: getAxisLabelStyle(premiumData.length)
                        },
                        yAxis: {
                            type: 'value',
                            name: '年计划达成率 (%)',
                            axisLine: { show: true },
                            axisLabel: { fontWeight: 'bold' },
                            min: 0,
                            max: 130,
                            splitLine: { show: false }
                        },
                        series: [{
                            name: '年计划达成率',
                            type: 'bar',
                            data: premiumData.map(d => ({
                                value: d.年计划达成率,
                                itemStyle: {
                                    color: getStatusColor(d.变动成本率)
                                }
                            })),
                            label: {
                                show: true,
                                position: 'top',
                                formatter: params => `${params.value.toFixed(1)}%`,
                                fontSize: 10,
                                fontWeight: 'bold'
                            },
                            markLine: {
                                silent: true,
                                lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                data: [{ yAxis: 100, label: { formatter: '达标线: 100%' } }]
                            }
                        }]
                    };
                    } else {
                        // 无计划数据 - 显示签单保费分布（从低到高排序）
                        let filtered = [...data];
                        if (dimension === 'category') {
                            filtered = filtered.filter(d => d.签单保费 > 1000000);
                        } else if (dimension === 'businessType') {
                            filtered = filtered.filter(d => d.签单保费 > 5000000);
                        }
                        const sortedData = filtered.sort((a, b) => a.签单保费 - b.签单保费);
                        option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: params => {
                                    const name = params[0].name;
                                    const idx = sortedData.findIndex(d => d[dimField] === name);
                                    const item = sortedData[idx];
                                    return `${name}<br/>
                                           签单保费: ${Math.round(item.签单保费/10000)}万元<br/>
                                           保费占比: ${item.保费占比.toFixed(1)}%<br/>
                                           变动成本率: ${item.变动成本率.toFixed(1)}%`;
                                }
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                data: sortedData.map(d => d[dimField]),
                                axisLabel: getAxisLabelStyle(sortedData.length)
                            },
                            yAxis: {
                                type: 'value',
                                name: '签单保费 (万元)',
                                axisLine: { show: true },
                                axisLabel: { fontWeight: 'bold' },
                                min: 0,
                                splitLine: { show: false }
                            },
                            series: [{
                                name: '签单保费',
                                type: 'bar',
                                data: sortedData.map(d => ({
                                    value: Math.round(d.签单保费/10000),
                                    itemStyle: { color: getStatusColor(d.变动成本率) }
                                })),
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: params => `${params.value}万`,
                                    fontSize: 10,
                                    fontWeight: 'bold'
                                }
                            }]
                        };
                    }
                } else if (tab === 'loss') {
                    // 损失暴露 - 气泡图或二级指标分析
                    const subTab = currentSubTab['loss'] || 'bubble';
                    
                    if (subTab === 'bubble') {
                        // 气泡图: X=满期赔付率, Y=当年已报告赔款占比（气泡大小：满期赔付率）
                        option = {
                            grid: {
                                left: '5%',
                                right: '15%',
                                bottom: '10%',
                                top: '5%',
                                containLabel: true
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: params => {
                                    const d = params.data;
                                    return `${d.name}<br/>
                                           满期赔付率: ${d.value[0].toFixed(1)}%<br/>
                                           已报告赔款占比: ${d.value[1].toFixed(1)}%<br/>
                                           保费占比: ${d.value[4].toFixed(1)}%<br/>
                                           签单保费: ${Math.round(d.value[3]/10000)}万元`;
                                }
                            },
                            xAxis: {
                                name: '满期赔付率 (%)',
                                nameLocation: 'middle',
                                nameGap: 30,
                                splitLine: { show: false },
                                min: 0,
                                max: 130,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            yAxis: {
                                name: '已报告赔款占比 (%)',
                                nameLocation: 'middle',
                                nameGap: 40,
                                splitLine: { show: false },
                                min: 0,
                                max: 50,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            series: [{
                                type: 'scatter',
                                symbolSize: (value, params) => {
                                    const values = data.map(d => d.签单保费 || 0);
                                    const dataIndex = params.dataIndex;
                                    return calculateBubbleSize(values, dataIndex);
                                },
                                data: data.map(d => ({
                                    name: d[dimField],
                                    value: [d.满期赔付率, d.已报告赔款占比, d.变动成本率, d.签单保费, d.保费占比],
                                    itemStyle: {
                                        color: getStatusColor(d.变动成本率),
                                        opacity: 0.7
                                    }
                                })),
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: params => {
                                        const name = params.data.name;
                                        const paidRate = params.data.value[0].toFixed(1);
                                        const claimShare = params.data.value[1].toFixed(1);
                                        const premiumShare = params.data.value[4].toFixed(1);
                                        return `{b|${name}} ${paidRate}% | ${claimShare}% | ${premiumShare}%`;
                                    },
                                    fontSize: 10,
                                    color: params => {
                                        const claimShare = params.data.value[1];
                                        const premiumShare = params.data.value[4];
                                        return claimShare > premiumShare ? '#d32f2f' : 'white';
                                    },
                                    textBorderColor: params => {
                                        const claimShare = params.data.value[1];
                                        const premiumShare = params.data.value[4];
                                        return claimShare > premiumShare ? '#8b0000' : 'black';
                                    },
                                    textBorderWidth: 2,
                                    rich: {
                                        b: { fontWeight: 'bold' }
                                    }
                                },
                                labelLayout: { hideOverlap: true },
                                markLine: {
                                    silent: true,
                                    lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                    data: [
                                        { xAxis: DATA.thresholds['四象限基准线']['满期赔付率'], label: { formatter: '赔付率基准: ' + DATA.thresholds['四象限基准线']['满期赔付率'] + '%' } }
                                    ]
                                }
                            }]
                        };
                    } else {
                        // 二级指标: X=出险率, Y=案均赔款（气泡大小：满期赔付率）
                        option = {
                            grid: {
                                left: '5%',
                                right: '15%',
                                bottom: '10%',
                                top: '5%',
                                containLabel: true
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: params => {
                                    const d = params.data;
                                    return `${d.name}<br/>
                                           出险率: ${d.value[0].toFixed(1)}%<br/>
                                           案均赔款: ${Math.round(d.value[1])}元<br/>
                                           满期赔付率: ${d.value[2].toFixed(1)}%<br/>
                                           签单保费: ${Math.round(d.value[3]/10000)}万元`;
                                }
                            },
                            xAxis: {
                                name: '出险率 (%)',
                                nameLocation: 'middle',
                                nameGap: 30,
                                splitLine: { show: false },
                                min: 0,
                                max: 40,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            yAxis: {
                                name: '案均赔款 (元)',
                                nameLocation: 'middle',
                                nameGap: 40,
                                splitLine: { show: false },
                                min: 0,
                                max: 10000,
                                axisLabel: { fontWeight: 'bold' }
                            },
                            series: [{
                                type: 'scatter',
                                symbolSize: (value, params) => {
                                    const values = data.map(d => d.签单保费 || 0);
                                    const dataIndex = params.dataIndex;
                                    return calculateBubbleSize(values, dataIndex);
                                },
                                data: data.map(d => ({
                                    name: d[dimField],
                                    value: [d.出险率, d.案均赔款, d.满期赔付率, d.签单保费],
                                    itemStyle: {
                                        color: getStatusColor(d.变动成本率),
                                        opacity: 0.7
                                    }
                                })),
                                label: {
                                    show: true,
                                    position: 'inside',
                                    formatter: params => {
                                        const name = params.data.name;
                                        const freqRate = params.data.value[0].toFixed(1);
                                        const avgClaim = Math.round(params.data.value[1]);
                                        const paidRate = params.data.value[2].toFixed(1);
                                        return `{b|${name}} ${freqRate}% | ${avgClaim} | ${paidRate}%`;
                                    },
                                    fontSize: 10,
                                    color: params => {
                                        const freqRate = params.data.value[0];
                                        const avgClaim = params.data.value[1];
                                        const freqThr = DATA.thresholds['四象限基准线']['出险率'];
                                        const avgThr = DATA.thresholds['四象限基准线']['案均赔款'];
                                        return (freqRate > freqThr || avgClaim > avgThr) ? '#d32f2f' : 'white';
                                    },
                                    textBorderColor: params => {
                                        const freqRate = params.data.value[0];
                                        const avgClaim = params.data.value[1];
                                        const freqThr = DATA.thresholds['四象限基准线']['出险率'];
                                        const avgThr = DATA.thresholds['四象限基准线']['案均赔款'];
                                        return (freqRate > freqThr || avgClaim > avgThr) ? '#8b0000' : 'black';
                                    },
                                    textBorderWidth: 2,
                                    rich: {
                                        b: { fontWeight: 'bold' }
                                    }
                                },
                                labelLayout: { hideOverlap: true },
                                markLine: {
                                    silent: true,
                                    lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                    data: [
                                        { xAxis: DATA.thresholds['四象限基准线']['出险率'], label: { formatter: '出险率基准: ' + DATA.thresholds['四象限基准线']['出险率'] + '%' } },
                                        { yAxis: DATA.thresholds['四象限基准线']['案均赔款'], label: { formatter: '案均基准: ' + DATA.thresholds['四象限基准线']['案均赔款'] } }
                                    ]
                                }
                            }]
                        };
                    }
                } else if (tab === 'expense') {
                    // 费用支出 - 费用率散点图（气泡大小：费用率）
                    option = {
                        grid: {
                            left: '5%',
                            right: '15%',
                            bottom: '10%',
                            top: '5%',
                            containLabel: true
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => {
                                const d = params.data;
                                const expenseShare = d.value[3];
                                const premiumShare = d.value[4];
                                const diff = expenseShare - premiumShare;
                                return `${d.name}<br/>
                                       费用率: ${d.value[0].toFixed(1)}%<br/>
                                       费用占比: ${expenseShare.toFixed(1)}%<br/>
                                       保费占比: ${premiumShare.toFixed(1)}%<br/>
                                       费用占比差异: ${diff.toFixed(1)}%<br/>
                                       签单保费: ${Math.round(d.value[2]/10000)}万元`;
                            }
                        },
                        xAxis: {
                            name: '费用率 (%)',
                            nameLocation: 'middle',
                            nameGap: 30,
                            splitLine: { show: false },
                            min: 0,
                            max: 30,
                            axisLabel: { fontWeight: 'bold' }
                        },
                        yAxis: {
                            name: '费用占比超保费占比 (%)',
                            nameLocation: 'middle',
                            nameGap: 40,
                            splitLine: { show: false },
                            min: -10,
                            max: 10,
                            axisLabel: { fontWeight: 'bold' }
                        },
                        series: [{
                            type: 'scatter',
                            symbolSize: (value, params) => {
                                const values = data.map(d => d.签单保费 || 0);
                                const dataIndex = params.dataIndex;
                                return calculateBubbleSize(values, dataIndex);
                            },
                            data: data.map(d => {
                                // 计算费用占比（假设费用 = 签单保费 * 费用率）
                                const totalPremium = data.reduce((sum, item) => sum + item.签单保费, 0);
                                const totalExpense = data.reduce((sum, item) => sum + (item.签单保费 * item.费用率 / 100), 0);
                                const expenseShare = (d.签单保费 * d.费用率 / 100) / totalExpense * 100;
                                const premiumShare = d.保费占比;
                                const diff = expenseShare - premiumShare;

                                return {
                                    name: d[dimField],
                                    value: [d.费用率, diff, d.签单保费, expenseShare, premiumShare, d.变动成本率],
                                    itemStyle: {
                                        color: getStatusColor(d.变动成本率),
                                        opacity: 0.7
                                    }
                                };
                            }),
                            label: {
                                show: true,
                                position: 'inside',
                                formatter: params => {
                                    const name = params.data.name;
                                    const expenseRate = params.data.value[0].toFixed(1);
                                    const expenseShare = params.data.value[3].toFixed(1);
                                    const premiumShare = params.data.value[4].toFixed(1);
                                    return `{b|${name}} ${expenseRate}% | ${expenseShare}% | ${premiumShare}%`;
                                },
                                fontSize: 10,
                                color: params => {
                                    const expenseShare = params.data.value[3];
                                    const premiumShare = params.data.value[4];
                                    return expenseShare > premiumShare ? '#d32f2f' : 'white';
                                },
                                textBorderColor: params => {
                                    const expenseShare = params.data.value[3];
                                    const premiumShare = params.data.value[4];
                                    return expenseShare > premiumShare ? '#8b0000' : 'black';
                                },
                                textBorderWidth: 2,
                                rich: {
                                    b: { fontWeight: 'bold' }
                                }
                            },
                            labelLayout: { hideOverlap: true },
                            markLine: {
                                silent: true,
                                lineStyle: { type: 'solid', color: '#a02724', width: 3 },
                                data: [
                                    { xAxis: DATA.thresholds['四象限基准线']['费用率'], label: { formatter: '费用率基准: ' + DATA.thresholds['四象限基准线']['费用率'] + '%' } },
                                    { yAxis: 0, label: { formatter: '平衡线' } }
                                ]
                            }
                        }]
                    };
                } else {
                    // 默认柱状图（按签单保费从低到高排序）
                    const sortedData = [...data].sort((a, b) => a.签单保费 - b.签单保费);
                    option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: params => {
                                const name = params[0].name;
                                let result = `${name}<br/>`;
                                params.forEach(p => {
                                    const value = p.seriesName === '签单保费'
                                        ? Math.round(p.value) + '万元'
                                        : p.value.toFixed(1) + '%';
                                    result += `${p.marker}${p.seriesName}: ${value}<br/>`;
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['签单保费', '变动成本率'],
                            bottom: 10
                        },
                        xAxis: {
                            type: 'category',
                            data: sortedData.map(d => d[dimField]),
                            axisLabel: getAxisLabelStyle(sortedData.length)
                        },
                        yAxis: [
                            { type: 'value', name: '签单保费(万元)', axisLabel: { fontWeight: 'bold' }, splitLine: { show: false } },
                            { type: 'value', name: '成本率(%)', axisLabel: { fontWeight: 'bold' }, splitLine: { show: false }, min: 0, max: 130 }
                        ],
                        series: [
                            {
                                name: '签单保费',
                                type: 'bar',
                                data: sortedData.map(d => ({
                                    value: Math.round(d.签单保费 / 10000),
                                    itemStyle: { color: getStatusColor(d.变动成本率) }
                                })),
                            },
                            {
                                name: '变动成本率',
                                type: 'line',
                                yAxisIndex: 1,
                                data: sortedData.map(d => parseFloat(d.变动成本率.toFixed(1))),
                                itemStyle: { color: '#00b050' }
                            }
                        ]
                    };
                }

                chart.setOption(option);

                // ==================== 为气泡图添加指标表格 ====================
                // 检查是否为气泡图（scatter类型）
                const isBubbleChart = option.series && option.series[0] && option.series[0].type === 'scatter';

                if (isBubbleChart) {
                    // 移除旧的表格（如果存在）
                    const oldTable = chartDom.parentElement.querySelector('.indicator-table-container');
                    if (oldTable) {
                        oldTable.remove();
                    }

                    // 定义每个图表对应的指标
                    let indicators = [];
                    if (tab === 'overview' && data.some(d => d.年计划达成率)) {
                        // 经营概览 - 年计划达成率 vs 变动成本率
                        indicators = ['年计划达成率', '变动成本率', '签单保费'];
                    } else if (tab === 'cost') {
                        // 变动成本 - 满期赔付率 vs 费用率
                        indicators = ['满期赔付率', '费用率', '变动成本率', '签单保费'];
                    } else if (tab === 'loss' && currentSubTab['loss'] === 'bubble') {
                        // 损失暴露 - 满期赔付率 vs 已报告赔款占比
                        indicators = ['满期赔付率', '已报告赔款占比', '变动成本率', '签单保费'];
                    } else if (tab === 'loss' && currentSubTab['loss'] === 'quadrant') {
                        // 损失暴露 - 出险率 vs 案均赔款
                        indicators = ['出险率', '案均赔款', '变动成本率', '签单保费'];
                    } else if (tab === 'expense') {
                        // 费用支出
                        indicators = ['费用率', '变动成本率', '签单保费'];
                    }

                    // 生成并插入表格
                    if (indicators.length > 0) {
                        const tableHtml = generateIndicatorTable(data, dimField, indicators);
                        const tableContainer = document.createElement('div');
                        tableContainer.innerHTML = tableHtml;
                        chartDom.parentElement.appendChild(tableContainer.firstChild);
                    }
                }
                // ==================== 表格添加完成 ====================

            } catch (e) {
                console.error('Render chart error:', e);
                const chartDom = document.getElementById(`chart-${tab}`);
                if (chartDom) {
                    chartDom.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:red;">图表渲染出错: ${e.message}</div>`;
                }
            }
        }

        // 初始化渲染
        function renderKPI() {
            try {
                const summary = DATA.summary || {};
                const thresholds = DATA.thresholds && DATA.thresholds['四象限基准线'] ? DATA.thresholds['四象限基准线'] : {};
                const orgs = DATA.dataByOrg || [];
                
                // 1. 计算整体保费进度 (Total Premium / Total Plan)
                let totalPlan = 0;
                let hasPlanData = false;
                orgs.forEach(d => {
                    if (d.年计划达成率 && d.签单保费) {
                        totalPlan += d.签单保费 / (d.年计划达成率 / 100);
                        hasPlanData = true;
                    }
                });
                const progressRate = hasPlanData && totalPlan > 0 ? (summary.签单保费 / totalPlan * 100) : 0;

                // 辅助函数
                const formatVal = (val, fixed=1) => val !== undefined && val !== null ? val.toFixed(fixed) : '--';
                const formatMoney = (val) => val !== undefined && val !== null ? Math.round(val / 10000) : '--';
                const setStatus = (el, val, badThr, warnThr, isHighBad = true) => {
                    if (!el || val === undefined || val === null) return;
                    // isHighBad: true means higher is worse (Cost, Claim, Expense)
                    // false means lower is worse (Progress)
                    let cls = 'status-good';
                    if (isHighBad) {
                        if (val > badThr) cls = 'status-danger';
                        else if (val > warnThr) cls = 'status-warning';
                    } else {
                        if (val < badThr) cls = 'status-danger';
                        else if (val < warnThr) cls = 'status-warning';
                    }
                    el.className = `metric-value ${cls}`;
                };

                // 更新数值与颜色
                // 1. 保费进度
                const elProgress = document.getElementById('metric-progress');
                if (elProgress) {
                    elProgress.innerHTML = `${formatVal(progressRate)}<span class="metric-unit">%</span>`;
                    setStatus(elProgress, progressRate, 95, 100, false);
                }

                // 2. 变动成本率
                const elCost = document.getElementById('metric-cost-rate');
                if (elCost) {
                    const val = summary.变动成本率;
                    elCost.innerHTML = `${formatVal(val)}<span class="metric-unit">%</span>`;
                    setStatus(elCost, val, 93, 88, true);
                }

                // 3. 满期赔付率
                const elClaim = document.getElementById('metric-claim-rate');
                if (elClaim) {
                    const val = summary.满期赔付率;
                    elClaim.innerHTML = `${formatVal(val)}<span class="metric-unit">%</span>`;
                    setStatus(elClaim, val, 75, 70, true);
                }

                // 4. 费用率
                const elExpense = document.getElementById('metric-expense-rate');
                if (elExpense) {
                    const val = summary.费用率;
                    elExpense.innerHTML = `${formatVal(val)}<span class="metric-unit">%</span>`;
                    setStatus(elExpense, val, 17, 14, true);
                }

                // 5. 金额指标
                const premiumWan = summary.签单保费;
                const claimWan = summary.已报告赔款;
                const expenseWan = summary.签单保费 * (summary.费用率 / 100);
                const marginWan = summary.签单保费 * ((100 - summary.变动成本率) / 100);

                const elPrem = document.getElementById('metric-premium');
                if (elPrem) elPrem.innerHTML = `${formatMoney(premiumWan)}<span class="metric-unit">万元</span>`;
                
                const elMargin = document.getElementById('metric-margin');
                if (elMargin) elMargin.innerHTML = `${formatMoney(marginWan)}<span class="metric-unit">万元</span>`;
                
                const elClaimAmt = document.getElementById('metric-claim');
                if (elClaimAmt) elClaimAmt.innerHTML = `${formatMoney(claimWan)}<span class="metric-unit">万元</span>`;
                
                const elExpAmt = document.getElementById('metric-expense');
                if (elExpAmt) elExpAmt.innerHTML = `${formatMoney(expenseWan)}<span class="metric-unit">万元</span>`;

                // 6. 异常标题
                const alerts = [];
                const orgName = DATA.isSingleOrgMode ? DATA.organization : '分公司';
                if (progressRate < 95) alerts.push(orgName + '保费达成进度落后');
                if ((summary.变动成本率 || 0) > 93) alerts.push('变动成本率异常');
                if ((summary.满期赔付率 || 0) > 75) alerts.push('满期赔付率异常');
                if ((summary.费用率 || 0) > 17) alerts.push('费用率异常');
                
                const titleEl = document.getElementById('kpi-alert-title');
                if (titleEl) titleEl.textContent = alerts.length ? alerts.join('、') : '重点指标正常';

            } catch (e) {
                console.error('Render KPI error:', e);
            }
        }

        renderKPI();
        renderChart('overview');
    </script>
</body>
</html>
