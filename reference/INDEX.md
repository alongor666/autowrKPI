# 📋 业务规则与配置核心层 (reference/)

> **职责**: 唯一事实来源 - 业务类型映射、KPI阈值、年度计划
> **更新时间**: 2026-01-02
> **变更规则**: 🔒 禁止擅自修改；任何变更必须先创建ADR决策记录

---

## 📖 目录职责

本目录是车险经营分析系统的 **业务规则唯一事实来源**，包含所有配置化的业务逻辑。任何代码中的硬编码阈值、映射规则均应迁移至此目录。

---

## 🔒 核心配置文件（最高权威）

| 文件 | 格式 | 职责 | 使用场景 | 变更规则 |
|------|------|------|---------|---------|
| **business_type_mapping.json** | JSON | 业务类型标准化映射 | 数据导入时将原始业务类型转换为标准UI显示值 | 🔒 必须ADR |
| **thresholds.json** | JSON | KPI阈值配置 | KPI卡片颜色判定、图表预警线绘制 | 🔒 必须ADR |
| **year-plans.json** | JSON | 年度保费计划 | 计算保费进度率（实际/计划） | 🔒 必须ADR |

---

## 📂 文件详解

### 1️⃣ business_type_mapping.json

**用途**: 将CSV中的原始业务类型值映射为标准化的UI显示值

**结构**:
```json
{
  "原始值1": "标准化显示值A",
  "原始值2": "标准化显示值A",
  "原始值3": "标准化显示值B"
}
```

**示例**:
```json
{
  "交强险": "交强险",
  "交强": "交强险",
  "商业险": "商业险",
  "商险": "商业险",
  "车损险": "商业险",
  "三者险": "商业险"
}
```

**使用位置**:
- `js/data.worker.js:150-250` - `mapBusinessTypes()` 函数
- 数据处理流程：CSV解析 → 业务类型映射 → KPI计算

**关联功能**:
- [F002 - 业务类型映射与转换](../开发文档/01_features/F002_business_mapping/README.md)

**变更影响**:
- ✅ 影响：UI显示的业务类型分类统计
- ⚠️ 风险：修改可能导致历史数据对比失效
- 📋 变更流程：
  1. 创建ADR（`/开发文档/decisions/DXXX_业务类型映射调整.md`）
  2. 说明：新增映射的原因、影响的数据范围、是否需要数据回溯
  3. 修改本文件
  4. 更新 [F002文档](../开发文档/01_features/F002_business_mapping/README.md)
  5. 通知相关方并测试

---

### 2️⃣ thresholds.json

**用途**: 定义KPI的良好/警告/危险边界值

**结构**:
```json
{
  "变动成本率": { "良好": 91, "警告": 94 },
  "满期赔付率": { "良好": 70, "警告": 75 },
  "费用率": { "良好": 14, "警告": 17 }
}
```

**完整内容**:
```json
{
  "变动成本率": {
    "良好": 91,
    "警告": 94
  },
  "满期赔付率": {
    "良好": 70,
    "警告": 75
  },
  "费用率": {
    "良好": 14,
    "警告": 17
  },
  "保费进度率": {
    "良好": 100,
    "警告": 95
  }
}
```

**使用位置**:
- `js/dashboard.js:82-106` - KPI卡片颜色判定逻辑
- `js/dashboard.js:404-616` - 图表预警线绘制（满期赔付率统一为70%）

**判定逻辑**:
| KPI | 良好（绿色） | 警告（黄色） | 危险（红色） |
|-----|------------|------------|------------|
| 变动成本率 | ≤91% | >91% 且 ≤94% | >94% |
| 满期赔付率 | ≤70% | >70% 且 ≤75% | >75% |
| 费用率 | ≤14% | >14% 且 ≤17% | >17% |
| 保费进度率 | ≥100% | ≥95% 且 <100% | <95% |

**关联功能**:
- [F003 - KPI计算引擎](../开发文档/01_features/F003_kpi_calculation/README.md)
- [板块文档/01_指标体系.md](../开发文档/板块文档/01_指标体系.md)

**变更影响**:
- ✅ 影响：KPI卡片颜色、图表预警线位置
- ⚠️ 风险：修改可能导致告警策略变化，影响业务决策
- 📋 变更流程：
  1. 创建ADR（`/开发文档/decisions/DXXX_KPI阈值调整.md`）
  2. 说明：调整原因、业务背景、影响的KPI、新旧阈值对比
  3. 修改本文件
  4. 更新 [指标体系文档](../开发文档/板块文档/01_指标体系.md)
  5. 通知相关方并验证告警逻辑

---

### 3️⃣ year-plans.json

**用途**: 存储年度保费计划数据，用于计算保费进度率

**结构**:
```json
{
  "2025": {
    "全年计划": 1000000000,
    "周计划": {
      "1": 19230769,
      "2": 19230769,
      ...
    }
  }
}
```

**使用位置**:
- `js/data.worker.js:244-309` - `calculateKPIsForGroup()` 函数中的保费进度率计算
- 计算公式：`保费进度率 = (实际保费 / 计划保费) × 100`

**关联功能**:
- [F003 - KPI计算引擎](../开发文档/01_features/F003_kpi_calculation/README.md)
- [板块文档/03_保费进度板块.md](../开发文档/板块文档/03_保费进度板块.md)

**变更影响**:
- ✅ 影响：保费进度率KPI、保费进度板块图表
- ⚠️ 风险：修改可能导致进度率异常、历史数据对比失效
- 📋 变更流程：
  1. 创建ADR（`/开发文档/decisions/DXXX_年度计划调整.md`）
  2. 说明：调整原因（如年度计划调整、周计划重新分配）
  3. 修改本文件
  4. 更新 [保费进度板块文档](../开发文档/板块文档/03_保费进度板块.md)
  5. 验证计算逻辑

---

## 🔗 与其他层的关联

### 代码依赖（/js）
- **data.worker.js**: 加载并应用所有配置文件
- **dashboard.js**: 使用阈值配置判定KPI状态

### 文档关联（/开发文档）
- **板块文档/01_指标体系.md**: 详细说明KPI定义与阈值规则
- **decisions/**: 记录所有配置变更的决策过程
- **01_features/F002, F003**: 功能实施文档

---

## 🔄 变更协议（强制执行）

### ⚠️ 变更前必须完成的步骤

1. **创建ADR**（Architecture Decision Record）
   - 路径：`/开发文档/decisions/DXXX_[变更主题].md`
   - 必须包含：
     - **背景**：为什么需要修改
     - **影响范围**：影响哪些KPI/功能/数据
     - **替代方案**：考虑过哪些其他方案
     - **回滚策略**：如何撤销此变更

2. **评审与确认**
   - 业务方确认：涉及阈值/计划的变更
   - 技术方确认：涉及映射规则的变更

3. **执行变更**
   - 修改配置文件
   - 更新关联功能文档
   - 更新本INDEX.md

4. **验证与测试**
   - 导入测试数据
   - 验证KPI计算正确性
   - 验证图表预警线位置
   - 对比历史数据一致性

---

## 📌 维护注意事项

- **禁止直接修改**：任何变更必须先创建ADR
- **禁止硬编码**：代码中不得出现阈值、映射的硬编码值
- **版本控制**：建议为重大变更创建备份（如 `thresholds_20260102_backup.json`）
- **文档同步**：配置变更必须同步更新相关功能文档和指标体系文档

---

**全局代码索引**: [CODE_INDEX.md](../开发文档/00_index/CODE_INDEX.md)
**决策记录入口**: [decisions/INDEX.md](../开发文档/decisions/INDEX.md)
**最后更新**: 2026-01-02
**维护者**: autowrKPI Governance Team
