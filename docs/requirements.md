# 需求规格说明（SRS）

## 业务目标
- 读取标准化车险变动成本明细 CSV，生成符合终极模板的经营分析周报 HTML，支持不同周次/年份/机构名称的复用。

## 用户场景
- 省分公司经营管理：导入最新周度数据，快速得到可展示的经营分析。
- 分析与汇报：对比不同机构/客户类别/业务类型的成本、赔付、进度情况，识别异常。

## 功能需求
- 数据输入：接受符合数据契约的 CSV，命令行可指定路径；自动从文件名/列推断周次与年份，支持手工覆盖。
- 报表输出：基于指定 HTML 模板，注入 DATA JSON、更新标题（机构+周次）与数据截止日期（周六）；输出到指定路径。
- 维度与图表：支持机构/客户类别/业务类型 3 个维度；标签页覆盖经营概览、保费进度、变动成本、损失暴露、费用支出；支持子视图切换（损失暴露气泡/二级指标）。
- 阈值与告警：读取阈值配置识别问题机构、渲染四象限基准线。
- 配置化：业务类型映射、年度计划、阈值可通过外部 JSON 切换；机构名称、模板、输出可配置。

## 场景适配与逻辑 (New)
- **模式识别**：
  - **单机构模式**：若数据中仅含单一三级机构，自动切换为单机构模式。
    - 标题去除“分公司”字样（如“XX车险第N周经营分析”）。
    - “关键数据”面板展示该机构专属KPI。
    - 保费进度分析：标题展示0保费类别，图表仅展示>0保费类别，正文列出Top3。
  - **分公司模式**（默认）：若含多个（或≥12个）三级机构。
    - 标题包含“分公司”（如“XX分公司车险第N周经营分析”）。
    - 保费进度分析：按计划达成率分组展示。
- **数据导入体验**：
  - 报告页面提供悬浮按钮，支持一键返回上传页面导入新数据（周数/机构可不同）。
- **UI文案**：
  - “分公司KPI”统一更名为“关键数据”。
  - 异常告警标题动态适配机构名称。

## 非功能需求
- 兼容性：Python 3.10+；纯本地运行，无需网络；模板依赖本地 ECharts CDN 回退。
- 性能：单次处理 10 万行以内 CSV 在秒级完成（依赖机器性能）。
- 可维护性：模块化（Loader/Mapper/KPI/Generator）；配置外置；字段契约稳定。

## 验收标准
- 使用示例数据成功生成报告，标题/日期与周次/年份一致，标签页和图表均可正常交互。
- 更换为任意同结构 CSV（值不同）仍可生成，指标与手工计算示例一致。
- 问题机构与阈值配置匹配，四象限/基准线正确显示。
- 单机构数据与多机构数据均能正确适配标题与图表逻辑。
